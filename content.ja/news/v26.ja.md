+++
title = "バージョン 26.x のニュース発表"
linkTitle = "バージョン 26.x"
toc_hide = "true"
description = "Protocol Buffers バージョン 26.x に関する変更が発表されました。"
type = "docs"
+++

以下の発表はバージョン 26.x に特有です。時系列で表示された情報については、[ニュース](/news) を参照してください。

## 一般的な変更

### JSON フォーマッタオプションの変更 {#JSON}

26.x ラインから、デフォルト値のフィールドを出力するための JSON フォーマッタオプションが、proto2 および proto3 の `optional` フィールドを一貫して処理する固定された方法に置き換えられました。

*   Java: `includingDefaultValueFields()` は `alwaysPrintFieldsWithNoPresence()` に置き換えられました。
*   C++: `always_print_default_values` は `always_print_fields_with_no_presence=True` に置き換えられました。
*   Py: `including_default_value_fields=True` は `always_print_fields_with_no_presence=True` に置き換えられました。

新しいフラグは、proto3 メッセージでは古いフラグと同じように動作しますが、もはや proto2 の `optional` フィールドには適用されません。古いフラグは proto2 の `optional` フィールドに適用されましたが、proto3 の `optional` フィールドには適用されませんでした。

### Poison Pilling Gencode / Runtime Mismatches

当社の[クロスバージョンランタイム保証](/support/cross-version-runtime-guarantee)によると、Protobuf はメジャーバージョンの境界を越えた生成コードとランタイムの混在、または新しい protoc バージョンから古いランタイムへの生成コードの混在をサポートしていません。これらの許可されていない不一致を検出および強制するために「毒薬ピル」を導入する予定です。

これは既存のポリシーの強制を追加するだけなので、これは破壊的な変更とは見なされませんが、ユーザーが生成コードを更新する必要があるかもしれません。

## C++ の破壊的な変更

v26 では、C++ についてメジャーバージョンのバージョンアップを計画しています。[破壊的変更ポリシー](/news/2022-07-06) および [バージョンサポートポリシー](/support/version-support#cpp-tooling) に従います。

以下のセクションでは、protocol buffers の 26.0 リリースに含める予定の破壊的変更のセットを概説しています。計画は変更される可能性があります。これらは認識しておくべき潜在的な破壊的変更ですが、この特定のリリースで発生するかどうか、または全く発生しないかもしれません。

### 繰り返しフィールドの非推奨なクリアAPIを削除する

次の非推奨メソッドが削除されました：

*   `RepeatedPtrField::ReleaseCleared()`
*   `RepeatedPtrField::ClearedCount()`
*   `RepeatedPtrField::AddCleared()`

{/*examples*/}

### C++のレガシー構文記述子APIを削除する

[エディション](/editions)のリリースに伴い、構文はビジネスロジックではもはやサポートされていません。代わりに、
[`descriptor.h`](/reference/cpp/api-docs/google.protobuf.descriptor)
で定義されたさまざまな機能ヘルパーを使用して、
[`has_presence`](/reference/cpp/api-docs/google.protobuf.descriptor#FieldDescriptor.has_presence.details)
などのよりターゲットされた動作をクエリするために使用してください。

{/*examples*/}

### 非推奨の構文アクセサを削除する

非推奨の構文アクセサである `FileDescriptor::Syntax` をv26で削除する予定です。代わりに、`FileDescriptor::edition` からのゲッターを使用することをお勧めします。

{/*examples*/}

### 非推奨のSupportsUnknownEnumValuesメソッドを削除する

`SupportsUnknownEnumValues` メソッドは、2023年3月に非推奨となりました。v26で削除する予定です。

{/*examples*/}

### std::stringエラーコレクターのオーバーライドを削除する

非推奨の `std::string` メソッドをエラーコレクターから削除する予定です。

{/*examples*/}

## Javaの破壊的変更

v26では、Javaのメジャーバージョンを大幅に変更する予定です。[破壊的変更ポリシー](/news/2022-07-06)および[バージョンサポートポリシー](/support/version-support#java)に従います。

以下のセクションでは、プロトコルバッファの26.0リリースに含まれる一連の破壊的変更を概説しています。計画は変更される可能性があります。これらは認識しておくべき潜在的な破壊的変更ですが、この特定のリリースで発生するかどうか、または全く発生しないかもしれません。

{/*examples*/}

これは既存の[クロスバージョンランタイム保証](/support/cross-version-runtime-guarantee)に準拠しており、破壊的な変更です。

### 廃止されたメソッド/変数の削除

v26.x では、廃止されたメソッドや変数へのアクセスが削除されます。これらは通常、以前のリリースで既に`@Deprecated`とマークされているでしょう。

以下の非網羅的なリストへのアクセスが削除されます：

*   ディスクリプタ構文のAPIは、対応する機能アクセサ（`FieldDescriptor.hasPresence()`、`EnumDescriptor.isClosed()`など）に置き換える必要があります。

*   TextFormat の印刷メソッドは、対応する`TextFormat.printer()`メソッドに置き換える必要があります。

*   PARSER 変数は、`parser()`メソッドに置き換える必要があります。

*   古い v2.x.x ジェネレートコードの互換性のためのランタイムメソッド。これは、[クロスバージョンランタイム保証](/support/cross-version-runtime-guarantee)に従ってサポートされなくなりました。

詳細は対応するリリースノートで入手できます。

## PHPの破壊的変更

26.x ラインで計画されている変更は次のとおりです：

*   文字列フィールドのセッターでUTF-8を検証します。
*   汎用サービスを削除します。
    ([commit 40ad3fa](https://github.com/protocolbuffers/protobuf/commit/40ad3fac603ba3c96e52a1266cd785a7adb8e3e4))

## Pythonの破壊的変更

v26 では、[破壊的変更ポリシー](/news/2022-07-06)および[バージョンサポートポリシー](/support/version-support#python-support)に従い、Pythonのメジャーバージョンの更新を計画しています。

26.x ラインで計画されている変更は次のとおりです：

*   `str(msg)` が文字列フィールドの無効なUTF-8をエスケープするようにします。
*   `text_format.MessageToString()` がデフォルトで生のUTF-8を出力するようにし、無効なUTF-8シーケンスをエスケープします。
*   タイムスタンプの境界を修正します（[commit 1250d5f](https://github.com/protocolbuffers/protobuf/commit/1250d5f6cccb0a45f959c7219980a0aad5060ee5)）

### 廃止されたAPIの削除

26.x リリースでは、以下の廃止されたAPIが削除されます：

*   [`AddFileDescriptor`](https://googleapis.dev/python/protobuf/latest/google/protobuf/descriptor_pool.html#google.protobuf.descriptor_pool.DescriptorPool.AddFileDescriptor)
*   [`AddDescriptor`](https://googleapis.dev/python/protobuf/latest/google/protobuf/descriptor_pool.html#google.protobuf.descriptor_pool.DescriptorPool.AddDescriptor)
*   [`AddEnumDescriptor`](https://googleapis.dev/python/protobuf/latest/google/protobuf/descriptor_pool.html#google.protobuf.descriptor_pool.DescriptorPool.AddEnumDescriptor)
*   [`AddExtensionDescriptor`](https://googleapis.dev/python/protobuf/latest/google/protobuf/descriptor_pool.html#google.protobuf.descriptor_pool.DescriptorPool.AddExtensionDescriptor)
*   [`AddServiceDescriptor`](https://googleapis.dev/python/protobuf/latest/google/protobuf/descriptor_pool.html#google.protobuf.descriptor_pool.DescriptorPool.AddServiceDescriptor)

### `None` イテラブルを使用したフィールドの拡張を拒否

26.x リリースから、`None` イテラブルを使用して繰り返しフィールドを拡張することは拒否されます（`TypeError` が発生します）。たとえば、`m.repeated_int32.extend(None)` は拒否されます。

### メッセージクラスでの `RegisterExtension` の削除

26.x リリースから、[`RegisterExtension`](https://googleapis.dev/python/protobuf/latest/google/protobuf/descriptor_pb2.html#google.protobuf.descriptor_pb2.DescriptorProto.ExtensionRange.RegisterExtension) が削除されます。Python で拡張機能にアクセスするには、メッセージオブジェクトの `Extensions` プロパティを使用します。

これは、純粋な Python と Python の C++ 実装の両方に影響しますが、upb Python には影響しません。

### GitHub からの `setup.py` と `setup.cfg` サポートの削除

26.x リリースでは、`python/` ディレクトリに `setup.py` と `setup.cfg` が存在しなくなります。これは、[GitHub リポジトリ](https://github.com/protocolbuffers/protobuf/tree/main/python)や GitHub [リリースターボール](https://github.com/protocolbuffers/protobuf/releases)から直接 Python パッケージをビルドすることができなくなることを意味します。

[PyPI に公開されている Python ソースパッケージ](https://pypi.org/project/protobuf/#files)には引き続きトップレベルディレクトリに `setup.py` が含まれます。これは、PyPI で配布しているバイナリパッケージを使用したくないユーザー向けに、Python バイナリパッケージをビルドするサポートされており推奨される方法です。

詳細については、[#15671](https://github.com/protocolbuffers/protobuf/pull/15671)を参照してください。

### タイムスタンプの妥当性チェック

v26 では、システムが `Timestamp` 値が有効かどうかをチェックします。秒は範囲[-62135596800、253402300799]内に、ナノ秒は範囲[0、999999999]内にある必要があります。これらの範囲外の値は例外を発生させます。

### 廃止された構文アクセサの削除

v26 では、廃止された構文アクセサである `FileDescriptor.syntax` を削除する予定です。その代わりに `FileDescriptor.edition` を追加する予定です。

### UnknownFields サポートの削除

v25 では、[`message.UnknownFields()`](https://googleapis.dev/python/protobuf/latest/google/protobuf/message.html#google.protobuf.message.Message.UnknownFields) が純粋な Python および C++ 拡張で非推奨となりました。v26 で削除する予定です。代わりに `unknown_fields.py` で新しい [`UnknownFieldSet(message)`](https://googleapis.dev/python/protobuf/latest/google/protobuf/unknown_fields.html) サポートを使用してください。

詳細な変更内容については、対応するリリースノートで確認できます。

## Ruby Breaking Changes

*   `RepeatedField#each_index` のセマンティクスを正しく修正しました。
    ([#11767](https://github.com/protocolbuffers/protobuf/pull/11767))
*   Ruby DSL および関連する互換性コードを削除しました。これにより、4月に発表された
    [移行](/news/2023-04-20) が完了します。
*   `Message#to_h` の修正:
    *   unset の oneof フィールドを削除しました。
        ([#6167](https://github.com/protocolbuffers/protobuf/issues/6167))
    *   unset のサブメッセージフィールドを削除しました。
*   [`encode_json`](https://github.com/protocolbuffers/protobuf/blob/2fb0b93d9de226ea96f2dc2b4779eb4712d01d5c/ruby/ext/google/protobuf_c/message.c#L1118)/[`decode_json`](https://github.com/protocolbuffers/protobuf/blob/2fb0b93d9de226ea96f2dc2b4779eb4712d01d5c/ruby/ext/google/protobuf_c/message.c#L1004) にメッセージのプールを使用します。
*   廃止された構文アクセサ `FileDescriptor.syntax` を削除し、代わりに意味検査を追加しました:
    *   `FieldDescriptor.has_presence` はフィールドが存在するかどうかをテストします。
    *   `FieldDescriptor.is_packed` は繰り返しフィールドがパックされているかどうかをテストします。
    *   `FieldDescriptor.requires_utf8_validation` は文字列フィールドが UTF-8 検証を必要とするかどうかをテストします。
    *   `EnumDescriptor.is_closed` は列挙型が閉じているかどうかをテストします。

### Ruby における Freeze は再帰的になりました

26.x ラインから、freeze が適用されると再帰的に適用され、すべてのサブメッセージ、マップ、および繰り返しフィールドに影響します。

## upb Breaking Changes

次の変更が 26.x ラインで予定されています:

*   `IgnoreUnknownEnumString` が有効になっている場合の JSON パースにおける
    [非準拠](https://github.com/protocolbuffers/protobuf/blob/2f7b2832b6a62fec88efacbb97bf0a91b6a3670e/upb/conformance/conformance_upb_failures.txt)
    を修正しました。
