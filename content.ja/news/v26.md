+++
title = "バージョン26.xのニュース発表"
linkTitle = "バージョン26.x"
toc_hide = "true"
description = "Protocol Buffersバージョン26.xの変更点が発表されました。"
type = "docs"
+++

以下の発表はバージョン26.xに特有です。時系列で表示される情報については[ニュース](/news)を参照してください。

## 一般的な変更

### JSONフォーマッタオプションの変更 {#JSON}

26.xラインから、デフォルト値のフィールドを出力するJSONフォーマッタオプションが、proto2およびproto3の`optional`フィールドを一貫して処理する固定された方法に置き換えられました。

*   Java: `includingDefaultValueFields()` は `alwaysPrintFieldsWithNoPresence()` に置き換えられました。
*   C++: `always_print_default_values` は `always_print_fields_with_no_presence=True` に置き換えられました。
*   Py: `including_default_value_fields=True` は `always_print_fields_with_no_presence=True` に置き換えられました。

新しいフラグは、proto3メッセージでは古いフラグと同じように動作しますが、もはやproto2の`optional`フィールドには適用されません。古いフラグはproto2の`optional`フィールドに適用されましたが、proto3の`optional`フィールドには適用されませんでした。

### Poison Pilling Gencode / Runtime Mismatches

当社の[クロスバージョンランタイム保証](/support/cross-version-runtime-guarantee)によると、Protobufはメジャーバージョンの境界を越えて生成されたコードとランタイムを混在させること、または新しいprotocの生成コードを古いランタイムと混在させることはサポートしていません。これらの許可されていない不一致を検出して強制するために、「毒薬ピル」を導入する予定です。

これは既存のポリシーの強制を追加するだけであるため、これは破壊的な変更とは見なされませんが、ユーザーが生成されたコードを更新する必要があるかもしれません。

## C++の破壊的な変更

v26では、C++についてメジャーバージョンのバンプを計画しています。これは当社の[破壊的変更ポリシー](/news/2022-07-06)および[バージョンサポートポリシー](/support/version-support#cpp-tooling)に従います。

以下のセクションでは、protocol buffersの26.0リリースに含める予定の破壊的な変更のセットを概説しています。計画は変更される可能性があります。これらは認識しておくべき潜在的な破壊的な変更ですが、この特定のリリースで発生するかどうか、または全く発生しないかもしれません。

### 繰り返しフィールドの非推奨なクリアAPIを削除

次の非推奨メソッドが削除されました：

*   `RepeatedPtrField::ReleaseCleared()`
*   `RepeatedPtrField::ClearedCount()`
*   `RepeatedPtrField::AddCleared()`

### C++のレガシー構文記述子APIを削除

[エディション](/editions)のリリースに伴い、構文はビジネスロジックではサポートされなくなりました。代わりに、C++でのよりターゲットを絞った動作をクエリするために、
[`descriptor.h`](/reference/cpp/api-docs/google.protobuf.descriptor)
で定義されたさまざまな機能ヘルパーを使用してください。たとえば、
[`has_presence`](/reference/cpp/api-docs/google.protobuf.descriptor#FieldDescriptor.has_presence.details)
などの機能をクエリするために使用します。

### 非推奨の構文アクセサを削除

非推奨の構文アクセサである `FileDescriptor::Syntax` をv26で削除する予定です。代わりに、`FileDescriptor::edition` からのゲッターを使用することをお勧めします。

### 非推奨のSupportsUnknownEnumValuesメソッドを削除

`SupportsUnknownEnumValues` メソッドは、2023年3月に非推奨となりました。v26で削除する予定です。

### std::stringエラーコレクターのオーバーライドを削除

非推奨の `std::string` メソッドをエラーコレクターから削除する予定です。

## Javaの破壊的変更

v26では、Javaのメジャーバージョンを大幅に変更する予定です。[破壊的変更ポリシー](/news/2022-07-06)および
[バージョンサポートポリシー](/support/version-support#java)に従います。

以下のセクションでは、プロトコルバッファの26.0リリースに含まれる一連の破壊的変更を概説しています。計画は変更される可能性があります。これらは認識しておくべき潜在的な破壊的変更ですが、この特定のリリースで発生するとは限らず、また全く発生しないかもしれません。

### 古い生成コードとの互換性の破壊

v26.xでは、古いメジャーバージョンから生成されたコードとの互換性が破壊されます。ユーザーは古い生成コードを同じバージョンから生成し直す必要があります。

たとえば、`GeneratedMessageV3` は、元々v2.x.xからv3.x.xランタイムへの生成コードとの後方互換性のために導入されたものでしたが、`GeneratedMessage` に名前が変更されます。ランタイムは、[エディション](/editions/overview/)をサポートするように更新され、古い生成コードと互換性がなくなります。

これは、既存の[クロスバージョンランタイム保証](/support/cross-version-runtime-guarantee)に準拠しており、破壊的な変更です。

### 廃止されたメソッド/変数の削除

v26.x では、廃止されたメソッドや変数へのアクセスが削除されます。これらは通常、以前のリリースで既に`@Deprecated`とマークされているはずです。

以下の非限定リストへのアクセスが削除されます：

*   Descriptor構文のAPIは、対応する機能アクセサ（例：`FieldDescriptor.hasPresence()`、`EnumDescriptor.isClosed()`）に置き換える必要があります。

*   TextFormatの印刷メソッドは、対応する`TextFormat.printer()`メソッドに置き換える必要があります。

*   PARSER変数は、`parser()`メソッドに置き換える必要があります。

*   古い v2.x.x ジェネレートコードの互換性のためのランタイムメソッド。これは、[クロスバージョンランタイム保証](/support/cross-version-runtime-guarantee)に従ってサポートされなくなりました。

詳細は、対応するリリースノートで入手できます。

## PHPの破壊的変更

次の変更が26.x ラインで計画されています：

*   文字列フィールドのセッターでUTF-8を検証します。
*   汎用サービスを削除します。
    ([commit 40ad3fa](https://github.com/protocolbuffers/protobuf/commit/40ad3fac603ba3c96e52a1266cd785a7adb8e3e4))

## Pythonの破壊的変更

v26 では、Pythonのメジャーバージョンの更新を計画しています。[破壊的変更ポリシー](/news/2022-07-06)および[バージョンサポートポリシー](/support/version-support#python-support)に従います。

次の変更が26.x ラインで計画されています：

*   `str(msg)` が文字列フィールド内の無効なUTF-8をエスケープするようにします。
*   `text_format.MessageToString()` が、無効なUTF-8シーケンスをエスケープしながら、デフォルトで生のUTF-8を出力するようにします。
*   タイムスタンプの境界を修正します（[commit 1250d5f](https://github.com/protocolbuffers/protobuf/commit/1250d5f6cccb0a45f959c7219980a0aad5060ee5)）

### 廃止されたAPIの削除

26.x リリースでは、以下の廃止されたAPIが削除されます：

*   [`AddFileDescriptor`](https://googleapis.dev/python/protobuf/latest/google/protobuf/descriptor_pool.html#google.protobuf.descriptor_pool.DescriptorPool.AddFileDescriptor)
*   [`AddDescriptor`](https://googleapis.dev/python/protobuf/latest/google/protobuf/descriptor_pool.html#google.protobuf.descriptor_pool.DescriptorPool.AddDescriptor)
*   [`AddEnumDescriptor`](https://googleapis.dev/python/protobuf/latest/google/protobuf/descriptor_pool.html#google.protobuf.descriptor_pool.DescriptorPool.AddEnumDescriptor)
*   [`AddExtensionDescriptor`](https://googleapis.dev/python/protobuf/latest/google/protobuf/descriptor_pool.html#google.protobuf.descriptor_pool.DescriptorPool.AddExtensionDescriptor)
*   [`AddServiceDescriptor`](https://googleapis.dev/python/protobuf/latest/google/protobuf/descriptor_pool.html#google.protobuf.descriptor_pool.DescriptorPool.AddServiceDescriptor)

### `None` Iterable で繰り返しフィールドを拡張することを拒否

26.x リリースから、`None` イテラブルで繰り返しフィールドを拡張することは拒否されます（`TypeError` が発生します）。例えば、`m.repeated_int32.extend(None)` は拒否されます。

### メッセージクラスでの `RegisterExtension` の削除

26.x リリースから、[`RegisterExtension`](https://googleapis.dev/python/protobuf/latest/google/protobuf/descriptor_pb2.html#google.protobuf.descriptor_pb2.DescriptorProto.ExtensionRange.RegisterExtension) が削除されます。Python では、メッセージオブジェクトの `Extensions` プロパティを使用して拡張にアクセスできます。

これは、純粋な Python と Python の C++ 実装の両方に影響しますが、upb Python には影響しません。

### GitHub からの `setup.py` と `setup.cfg` サポートの削除

26.x リリースでは、`python/` ディレクトリに `setup.py` と `setup.cfg` が存在しなくなります。これは、GitHub リポジトリまたは GitHub リリースの tarball から直接 Python パッケージをビルドすることができなくなることを意味します。

[PyPI に公開されている Python ソースパッケージ](https://pypi.org/project/protobuf/#files) には引き続きトップレベルディレクトリに `setup.py` が含まれます。これは、PyPI で配布しているバイナリパッケージを使用したくないユーザー向けに、Python バイナリパッケージをビルドするサポートされており推奨される方法です。

詳細については、[#15671](https://github.com/protocolbuffers/protobuf/pull/15671) を参照してください。

### タイムスタンプの妥当性チェック

v26 では、システムが `Timestamp` 値が有効かどうかをチェックします。秒は範囲 [-62135596800, 253402300799] に、ナノ秒は範囲 [0, 999999999] にある必要があります。これらの範囲外の値は例外を発生させます。

### 廃止された構文アクセサの削除

v26 では、廃止された構文アクセサである `FileDescriptor.syntax` を削除する予定です。その代わりに `FileDescriptor.edition` を追加する予定です。

### UnknownFields サポートの削除

v25 では、[`message.UnknownFields()`](https://googleapis.dev/python/protobuf/latest/google/protobuf/message.html#google.protobuf.message.Message.UnknownFields) が純粋な Python および C++ 拡張で非推奨となりました。v26 で削除する予定です。代わりに `unknown_fields.py` で新しい [`UnknownFieldSet(message)`](https://googleapis.dev/python/protobuf/latest/google/protobuf/unknown_fields.html) サポートを使用してください。

詳細な変更内容については、対応するリリースノートで確認できます。

## Ruby Breaking Changes

*   `RepeatedField#each_index` を正しいセマンティクスに修正しました。
    ([#11767](https://github.com/protocolbuffers/protobuf/pull/11767))
*   4月に発表された[移行](/news/2023-04-20)を完了するため、Ruby DSL および関連の互換性コードを削除しました。
*   `Message#to_h` の修正:
    *   unset の oneof フィールドを削除しました。
        ([#6167](https://github.com/protocolbuffers/protobuf/issues/6167))
    *   unset のサブメッセージフィールドを削除しました。
*   [`encode_json`](https://github.com/protocolbuffers/protobuf/blob/2fb0b93d9de226ea96f2dc2b4779eb4712d01d5c/ruby/ext/google/protobuf_c/message.c#L1118)/[`decode_json`](https://github.com/protocolbuffers/protobuf/blob/2fb0b93d9de226ea96f2dc2b4779eb4712d01d5c/ruby/ext/google/protobuf_c/message.c#L1004) にメッセージのプールを使用しました。
*   廃止された構文アクセサー `FileDescriptor.syntax` を削除し、代わりに意味的なチェックを追加しました:
    *   `FieldDescriptor.has_presence` はフィールドが存在するかどうかをテストします。
    *   `FieldDescriptor.is_packed` は繰り返しフィールドがパックされているかどうかをテストします。
    *   `FieldDescriptor.requires_utf8_validation` は文字列フィールドが UTF-8 検証を必要とするかどうかをテストします。
    *   `EnumDescriptor.is_closed` は列挙型が閉じているかどうかをテストします。

### Ruby における Freeze は再帰的になりました

26.x ラインから、freeze が適用されると再帰的に適用され、すべてのサブメッセージ、マップ、および繰り返しフィールドに影響します。

## upb Breaking Changes

26.x ラインで次の変更が予定されています:

*   `IgnoreUnknownEnumString` が有効になっている場合の JSON パースにおける[非準拠](https://github.com/protocolbuffers/protobuf/blob/2f7b2832b6a62fec88efacbb97bf0a91b6a3670e/upb/conformance/conformance_upb_failures.txt)を修正しました。
