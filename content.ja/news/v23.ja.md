+++
title = "バージョン 23.x のニュース発表"
linkTitle = "バージョン 23.x"
toc_hide = "true"
description = "Protocol Buffers バージョン 23.x に関する変更が発表されました。"
type = "docs"
+++

以下の発表はバージョン 23.x に特有です。時系列で表示される情報については、[ニュース](/news) を参照してください。

## Ruby ジェネレータへの変更 {#ruby}

[この GitHub PR](https://github.com/protocolbuffers/protobuf/pull/12319) は、23.x リリースで現れる Ruby コードジェネレータを DSL ではなくシリアライズされた proto を出力するように変更します。

これは、DSL をコードジェネレータから分離して別のパッケージに移動することを見越して DSL を削除します。

次のような .proto ファイルがあるとします：

```proto
syntax = "proto3";

package pkg;

message TestMessage {
  optional int32 i32 = 1;
  optional TestMessage msg = 2;
}
```

変更前の生成されたコード：

```ruby
# Generated by the protocol buffer compiler.  DO NOT EDIT!
# source: protoc_explorer/main.proto

require 'google/protobuf'

Google::Protobuf::DescriptorPool.generated_pool.build do
  add_file("test.proto", :syntax => :proto3) do
    add_message "pkg.TestMessage" do
      proto3_optional :i32, :int32, 1
      proto3_optional :msg, :message, 2, "pkg.TestMessage"
    end
  end
end

module Pkg
  TestMessage = ::Google::Protobuf::DescriptorPool.generated_pool.lookup("pkg.TestMessage").msgclass
end
```

変更後の生成されたコード：

```ruby
# frozen_string_literal: true
# Generated by the protocol buffer compiler.  DO NOT EDIT!
# source: test.proto

require 'google/protobuf'

descriptor_data = "\n\ntest.proto\x12\x03pkg\"S\n\x0bTestMessage\x12\x10\n\x03i32\x18\x01 \x01(\x05H\x00\x88\x01\x01\x12\"\n\x03msg\x18\x02 \x01(\x0b\x32\x10.pkg.TestMessageH\x01\x88\x01\x01\x42\x06\n\x04_i32B\x06\n\x04_msgb\x06proto3"
begin
  Google::Protobuf::DescriptorPool.generated_pool.add_serialized_file(descriptor_data)
rescue TypeError => e
  # <compatibility code, see below>
end

module Pkg
  TestMessage = ::Google::Protobuf::DescriptorPool.generated_pool.lookup("pkg.TestMessage").msgclass
end
```

この変更により、以前存在していたほぼすべての適合性の問題が修正されます。これは、DSL（情報が失われる）からシリアライズされた記述子（すべての情報を保持する）に移行する副作用です。

### 互換性 {#backward}

この変更は、2021 年 9 月にリリースされた Ruby Protobuf >= 3.18.0 と完全に互換性があります。さらに、すべての既存のユーザーと展開とも互換性があります。

このレベルの後方互換性を達成するために特別な互換性コードが挿入されています。この互換性コードがないと、後方互換性が壊れる可能性があるエッジケースがあります。以前のコードは、新しいコードよりも緩やかな方法であり、新しいコードはより厳格になります。

完全なシリアライズされた記述子を使用する場合、このファイルによってインポートされたすべての `.proto` ファイルのリストが含まれます（一方、DSL は依存関係を適切に追加していませんでした）。[`descriptor.proto`](https://github.com/protocolbuffers/protobuf/blob/dfb71558a2226718dc3bcf5df27cbc11c1f72382/src/google/protobuf/descriptor.proto#L65-L66) のコードを参照してください。

`add_serialized_file` は、記述子にリストされているすべての依存関係が以前に `add_serialized_file` で追加されていたことを検証します。一般的には、生成されたコードにはすべての依存関係のための Ruby `require` ステートメントが含まれており、もし依存する型が以前に `DescriptorPool` で定義されていなかった場合は、記述子の読み込みに失敗します。

しかし、ファイルパスに関する曖昧さがあると問題が発生する可能性があります。たとえば、次のシナリオを考えてみてください：

```proto
// foo/bar.proto

syntax = "proto2";

message Bar {}
```

```proto
// foo/baz.proto

syntax = "proto2";

import "bar.proto";

message Baz {
  optional Bar bar = 1;
}
```

次のように`protoc`を呼び出すと、正しく動作します：

```
$ protoc --ruby_out=. -Ifoo foo/bar.proto foo/baz.proto
$ RUBYLIB=. ruby baz_pb.rb
```

しかし、次のように`protoc`を呼び出し、互換性コードがない場合、ロードに失敗します：

```
$ protoc --ruby_out=. -I. -Ifoo foo/baz.proto
$ protoc --ruby_out=. -I. -Ifoo foo/bar.proto
$ RUBYLIB=foo ruby foo/baz_pb.rb
foo/baz_pb.rb:10:in `add_serialized_file': Unable to build file to DescriptorPool: Depends on file 'bar.proto', but it has not been loaded (Google::Protobuf::TypeError)
    from foo/baz_pb.rb:10:in `<main>'
```

問題は、`bar.proto`が2つの異なる正規名で参照されていることです：`bar.proto`と`foo/bar.proto`。これはユーザーエラーです：各インポートは常に一貫したフルパスで参照されるべきです。このような種類のユーザーエラーは稀であることを願っていますが、試してみないとわかりません。

この変更のコードは、このエッジケースが発生した場合に`warn`を使用して警告を出力します：

```
$ RUBYLIB=foo ruby foo/baz_pb.rb
Warning: Protobuf detected an import path issue while loading generated file foo/baz_pb.rb
- foo/baz.proto imports bar.proto, but that import was loaded as foo/bar.proto
Each proto file must use a consistent fully-qualified name.
This will become an error in the next major version.
```

この場合には2つの修正方法があります。1つは、インポートに名前`bar.proto`を一貫して使用することです（`-I.`を削除）。もう1つは、インポート行を`import "foo/bar.proto"`に変更し（`-Ifoo`を削除）、インポートに名前`foo/bar.proto`を一貫して使用することです。

次のメジャーバージョンでこの互換性コードを削除する予定です。

## Bazel <5.3 のサポート終了 {#bazel}

v23 では Bazel 4 のサポートが終了します。Protobuf は Bazel 5 LTS を引き続きサポートし、最小必要バージョンは Bazel 5.3 です。これは、[Foundational C++ Support Policy](https://opensource.google/documentation/policies/cplusplus-support#build_systems) で説明されているビルドサポートポリシーに従い、[Foundational C++ Support](https://github.com/google/oss-policies-info/blob/main/foundational-cxx-support-matrix.md) で反映されています。

## 構文リフレクションの非推奨化 {#deprecation}

v23 では、リフレクションを使用して構文バージョンをチェックする機能が非推奨化されます。非推奨化はビルド時に警告として含まれます。この機能は将来のリリースで削除されます。
