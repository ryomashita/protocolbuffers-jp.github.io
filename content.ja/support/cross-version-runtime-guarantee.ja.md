+++
title = "クロスバージョンランタイム保証"
weight = 930
description = "言語がクロスバージョンランタイム互換性に対して持つ保証。"
type = "docs"
+++

<link rel="stylesheet" href="/includes/version-tables.css">

Protobuf言語バインディングには2つのコンポーネントがあります。生成されたコード（通常は`protoc`から生成される）と、生成されたコードを使用する際に含める必要があるランタイムライブラリです。これらがProtobufの異なるリリースから来た場合、私たちは「クロスバージョンランタイム」の状況にあります。

私たちは、[C++](#cpp)を除くすべての言語に対して以下の保証を提供する意向です。これらはデフォルトの保証ですが、Protobufコードジェネレーターとランタイムの所有者は、その言語向けにより具体的な保証で明示的に上書きすることができます。

保証範囲外でのProtobufのクロスバージョン利用は**エラーのもとであり、サポートされていません**。バージョンのズレは、*フレークや未定義の動作*を引き起こす可能性があり、それらは診断が難しく、何も変更されていない限り*動作しているように見える*ことがよくあります。Protobufでは、サポートされていないProtobuf言語バインディングを使用するツールやサービスの増加が、バグレポートやセキュリティの脆弱性に対応するためにProtobufチームがProtobufの実装を更新することを妨げています。

## 新しい生成コード + 古いランタイム = 絶対NG {#backwards}

任意のリリース（メジャー、マイナー、パッチ）で新しいランタイムAPIを追加することがあります。そのリリースの生成コードは、これらの新しいAPIを使用することができます。その結果、生成コードは、それらのバインディングを生成するために使用された`protoc`およびプラグインよりも古いランタイムとペアにすべきではありません。

新しい生成コードを古いランタイムとペアにしようとする試みを防ぐために、可能な限り「毒薬の錠剤」を追加します。

## メジャーバージョン {#major}

2025Q1リリースから、Protobufプロジェクトはメジャーバージョンに対するローリング互換性ウィンドウを採用します。メジャーバージョンV（完全バージョン：V.x.y）向けに生成されたコードは、バージョンVおよびV+1のProtobufランタイムでサポートされます。

Protobufは、バージョンVの生成コードをランタイムV+2以上で使用することをサポートせず、「毒薬の錠剤」メカニズムを使用して、そのような構成を使用しようとするソフトウェアアセンブリが明確なエラーメッセージとともに失敗するようにします。

## マイナーバージョン {#minor}

単一のメジャーランタイムバージョン内では、古いバージョンの`protoc`から生成されたコードは新しいランタイム上で実行されます。

## セキュリティ例外 {#exception}

セキュリティ上の理由で必要に応じて上記の約束を破る権利を留保します。これらの例外は稀であることを期待していますが、常にこれらの保証よりもセキュリティを優先します。たとえば、[footmitten](https://cve.report/CVE-2022-3510) では、Javaのランタイムと生成されたコードの両方に対するペアの更新が必要でした。その結果、footmittenの修正が含まれていた3.20.3で生成されたコードは、footmittenの修正より前の3.21.6ランタイムライブラリとは読み込まれず、次の互換性行列が作成されました：

<table>
  <tr>
    <td colspan="2" rowspan="2"></td>
    <td colspan="4">生成されたコードのバージョン</td>
  </tr>
  <tr>
    <td class="gray">3.20.2</td>
    <td class="gray">3.20.3</td>
    <td class="gray">3.21.6</td>
    <td class="gray">3.21.7</td>
  </tr>
  <tr>
    <td rowspan="4">ランタイム<br>バージョン</td>
    <td class="gray">3.20.2</td>
    <td class="yellow">Vuln</td>
    <td class="red"><b>Broken</b></td>
    <td class="yellow"><b>Vuln</b></td>
    <td class="red"><b>Broken</b></td>
  </tr>
  <tr>
    <td class="gray">3.20.3</td>
    <td class="yellow">Vuln</td>
    <td class="green">Works</td>
    <td class="yellow"><b>Vuln</b></td>
    <td class="green"><b>Works?</b></td>
  </tr>
  <tr>
    <td class="gray">3.21.6</td>
    <td class="yellow">Vuln</td>
    <td class="red">Broken</td>
    <td class="yellow">Vuln</td>
    <td class="red"><b>Broken</b></td>
  </tr>
  <tr>
    <td class="gray">3.21.7</td>
    <td class="yellow">Vuln</td>
    <td class="green">Works</td>
    <td class="yellow">Vuln</td>
    <td class="green">Works</td>
  </tr>
</table>

*   “Vuln” は、組み合わせが正常に開始されるが、セキュリティ上の脆弱性がまだ存在することを示します。
*   “Works” は、組み合わせが正常に開始され、脆弱性が存在しないことを示します。
*   “Broken” は、組み合わせが正常に開始されないことを示します。
*   **Bold** は、このトピックで概説された保証に基づいて意図的に一緒に機能することが決して意図されていなかった構成を示します。

## 複数のメジャーランタイムバージョンの共存はできません {#coexist}

同じプロセス内で複数のメジャーバージョンを共存させることは**サポートされていません**。

## C++ 固有の保証 {#cpp}

Protobuf C++ は、クロスランタイムサポートを一切否定し、生成されたコードバージョンとランタイムバージョンが常に厳密に一致することを要求します。
さらに、Protobuf C++ は、リリース（メジャー、マイナー、マイクロ）を通じてABIの安定性について一切の保証をしません。
