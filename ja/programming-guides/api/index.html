<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=ja class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.121.2"><meta name=robots content="index, follow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>API ベストプラクティス | Protocol Buffers Documentation</title>
<meta name=description content="将来に耐えうる API を作成するのは驚くほど難しいです。この文書の提案は、長期的でバグのない進化を優先するためにトレードオフを行います。"><meta property="og:title" content="API ベストプラクティス"><meta property="og:description" content="将来に耐えうる API を作成するのは驚くほど難しいです。この文書の提案は、長期的でバグのない進化を優先するためにトレードオフを行います。"><meta property="og:type" content="article"><meta property="og:url" content="https://protobuf.dev/ja/programming-guides/api/"><meta property="article:section" content="programming-guides"><meta itemprop=name content="API ベストプラクティス"><meta itemprop=description content="将来に耐えうる API を作成するのは驚くほど難しいです。この文書の提案は、長期的でバグのない進化を優先するためにトレードオフを行います。"><meta itemprop=wordCount content="1783"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="API ベストプラクティス"><meta name=twitter:description content="将来に耐えうる API を作成するのは驚くほど難しいです。この文書の提案は、長期的でバグのない進化を優先するためにトレードオフを行います。"><link rel=preload href=/scss/main.min.6a57e8f3f347dea5d31cb48e3b4ea9fdae32d499473089bdef9b45457b5debb8.css as=style><link href=/scss/main.min.6a57e8f3f347dea5d31cb48e3b4ea9fdae32d499473089bdef9b45457b5debb8.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-5L8P8GRN4Y"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-5L8P8GRN4Y")}</script></head><body class=td-page><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/ja/><span class="navbar-brand__logo navbar-logo"></span><span class=navbar-brand__name>Protocol Buffers Documentation</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item dropdown mr-4 d-none d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>日本語</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/programming-guides/api/>English</a></div></li></ul></div><div class="navbar-nav d-none d-lg-block"><div class=td-search><div class=td-search__icon></div><input type=search class="td-search__input form-control td-search-input" placeholder=サイトを検索... aria-label=サイトを検索... autocomplete=off></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><div id=content-mobile><form class="td-sidebar__search d-flex align-items-center"><div class=td-search><div class=td-search__icon></div><input type=search class="td-search__input form-control td-search-input" placeholder=サイトを検索... aria-label=サイトを検索... autocomplete=off></div><button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-section-nav aria-expanded=false aria-label="Toggle section navigation"></button></form></div><div id=content-desktop></div><nav class="collapse td-sidebar-nav" id=td-section-nav><div class="nav-item dropdown d-block d-lg-none"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>日本語</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/programming-guides/api/>English</a></div></div><ul class="td-sidebar-nav__section pr-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-ja-li><a href=/ja/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-ja><span>Protocol Buffers</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jaoverview-li><a href=/ja/overview/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jaoverview><span>概要</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-janews-li><a href=/ja/news/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-janews><span>ニュース</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-janews2022-05-06-li><a href=/ja/news/2022-05-06/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-janews2022-05-06><span></span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-janews2023-07-06-li><a href=/ja/news/2023-07-06/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-janews2023-07-06><span></span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-janews2023-08-09-li><a href=/ja/news/2023-08-09/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-janews2023-08-09><span></span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-janews2023-08-15-li><a href=/ja/news/2023-08-15/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-janews2023-08-15><span></span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-janews2023-09-15-li><a href=/ja/news/2023-09-15/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-janews2023-09-15><span></span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-janews2023-12-27-li><a href=/ja/news/2023-12-27/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-janews2023-12-27><span></span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-janews2024-06-26-li><a href=/ja/news/2024-06-26/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-janews2024-06-26><span></span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-japrogramming-guides-li><a href=/ja/programming-guides/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-japrogramming-guides><span>プログラミングガイド</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japrogramming-guidesproto2-li><a href=/ja/programming-guides/proto2/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-japrogramming-guidesproto2><span>言語ガイド（proto 2）</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japrogramming-guidesproto3-li><a href=/ja/programming-guides/proto3/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-japrogramming-guidesproto3><span>言語ガイド（proto 3）</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japrogramming-guidesstyle-li><a href=/ja/programming-guides/style/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-japrogramming-guidesstyle><span>スタイルガイド</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japrogramming-guidesaddons-li><a href=/ja/programming-guides/addons/ title=サードパーティーアドオン class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-japrogramming-guidesaddons><span>アドオン</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-japrogramming-guidesapi-li><a href=/ja/programming-guides/api/ class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-japrogramming-guidesapi><span class=td-sidebar-nav-active-item>API ベストプラクティス</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japrogramming-guidesdos-donts-li><a href=/ja/programming-guides/dos-donts/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-japrogramming-guidesdos-donts><span></span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japrogramming-guidesencoding-li><a href=/ja/programming-guides/encoding/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-japrogramming-guidesencoding><span></span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japrogramming-guidesenum-li><a href=/ja/programming-guides/enum/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-japrogramming-guidesenum><span></span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japrogramming-guidesextension_declarations-li><a href=/ja/programming-guides/extension_declarations/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-japrogramming-guidesextension_declarations><span></span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japrogramming-guidesfield_presence-li><a href=/ja/programming-guides/field_presence/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-japrogramming-guidesfield_presence><span></span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japrogramming-guidesserialization-not-canonical-li><a href=/ja/programming-guides/serialization-not-canonical/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-japrogramming-guidesserialization-not-canonical><span></span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japrogramming-guidestechniques-li><a href=/ja/programming-guides/techniques/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-japrogramming-guidestechniques><span></span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-jaeditions-li><a href=/ja/editions/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-jaeditions><span>Protobuf Editions</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jaeditionsoverview-li><a href=/ja/editions/overview/ title="Protobuf Editions の概要" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jaeditionsoverview><span>概要</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jaeditionsfeatures-li><a href=/ja/editions/features/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jaeditionsfeatures><span>エディション向けの機能設定</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jaeditionsimplementation-li><a href=/ja/editions/implementation/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jaeditionsimplementation><span></span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-jagetting-started-li><a href=/ja/getting-started/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-jagetting-started><span>チュートリアル</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jagetting-startedcpptutorial-li><a href=/ja/getting-started/cpptutorial/ title="プロトコルバッファの基礎: C++" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jagetting-startedcpptutorial><span>C++</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jagetting-startedcsharptutorial-li><a href=/ja/getting-started/csharptutorial/ title="Protocol Buffer Basics: C#" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jagetting-startedcsharptutorial><span>C#</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jagetting-starteddarttutorial-li><a href=/ja/getting-started/darttutorial/ title="Protocol Buffer Basics: Dart" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jagetting-starteddarttutorial><span>Dart</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jagetting-startedgotutorial-li><a href=/ja/getting-started/gotutorial/ title="プロトコルバッファの基本: Go" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jagetting-startedgotutorial><span>Go</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jagetting-startedjavatutorial-li><a href=/ja/getting-started/javatutorial/ title="プロトコルバッファの基礎: Java" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jagetting-startedjavatutorial><span>Java</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jagetting-startedkotlintutorial-li><a href=/ja/getting-started/kotlintutorial/ title="Protocol Buffer Basics: Kotlin" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jagetting-startedkotlintutorial><span>Kotlin</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jagetting-startedpythontutorial-li><a href=/ja/getting-started/pythontutorial/ title="プロトコルバッファの基礎: Python" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jagetting-startedpythontutorial><span>Python</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-jareference-li><a href=/ja/reference/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-jareference><span>リファレンスガイド</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-jareferencecpp-li><a href=/ja/reference/cpp/ title="C++ リファレンス" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-jareferencecpp><span>C++</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jareferencecppcpp-generated-li><a href=/ja/reference/cpp/cpp-generated/ title="C++ 生成コードガイド" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jareferencecppcpp-generated><span>生成コードガイド</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jareferencecpparenas-li><a href=/ja/reference/cpp/arenas/ title="C++ アリーナ割り当てガイド" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jareferencecpparenas><span>アリーナ割り当てガイド</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jareferencecppapi-docs-link-li><a href=/reference/cpp/api-docs/ target=_blank rel=noopener class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jareferencecppapi-docs-link><span>C++ API</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jareferencecppapi-docsgoogleprotobufcompilercpp_generator-li><a href=/ja/reference/cpp/api-docs/google.protobuf.compiler.cpp_generator/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jareferencecppapi-docsgoogleprotobufcompilercpp_generator><span></span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jareferencecppapi-docsgoogleprotobufcompilercsharp_generator-li><a href=/ja/reference/cpp/api-docs/google.protobuf.compiler.csharp_generator/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jareferencecppapi-docsgoogleprotobufcompilercsharp_generator><span></span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jareferencecppapi-docsgoogleprotobufcompilercsharp_names-li><a href=/ja/reference/cpp/api-docs/google.protobuf.compiler.csharp_names/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jareferencecppapi-docsgoogleprotobufcompilercsharp_names><span></span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jareferencecppapi-docsgoogleprotobufcompilerjava_generator-li><a href=/ja/reference/cpp/api-docs/google.protobuf.compiler.java_generator/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jareferencecppapi-docsgoogleprotobufcompilerjava_generator><span></span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jareferencecppapi-docsgoogleprotobufcompilerjava_names-li><a href=/ja/reference/cpp/api-docs/google.protobuf.compiler.java_names/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jareferencecppapi-docsgoogleprotobufcompilerjava_names><span></span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jareferencecppapi-docsgoogleprotobufcompilerjavanano_generator-li><a href=/ja/reference/cpp/api-docs/google.protobuf.compiler.javanano_generator/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jareferencecppapi-docsgoogleprotobufcompilerjavanano_generator><span></span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jareferencecppapi-docsgoogleprotobufcompilerjs_generator-li><a href=/ja/reference/cpp/api-docs/google.protobuf.compiler.js_generator/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jareferencecppapi-docsgoogleprotobufcompilerjs_generator><span></span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jareferencecppapi-docsgoogleprotobufcompilerobjectivec_generator-li><a href=/ja/reference/cpp/api-docs/google.protobuf.compiler.objectivec_generator/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jareferencecppapi-docsgoogleprotobufcompilerobjectivec_generator><span></span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jareferencecppapi-docsgoogleprotobufcompilerparser-li><a href=/ja/reference/cpp/api-docs/google.protobuf.compiler.parser/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jareferencecppapi-docsgoogleprotobufcompilerparser><span></span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jareferencecppapi-docsgoogleprotobufcompilerplugin-li><a href=/ja/reference/cpp/api-docs/google.protobuf.compiler.plugin/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jareferencecppapi-docsgoogleprotobufcompilerplugin><span></span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jareferencecppapi-docsgoogleprotobufcompilerpluginpb-li><a href=/ja/reference/cpp/api-docs/google.protobuf.compiler.plugin.pb/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jareferencecppapi-docsgoogleprotobufcompilerpluginpb><span></span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jareferencecppapi-docsgoogleprotobufcompilerpython_generator-li><a href=/ja/reference/cpp/api-docs/google.protobuf.compiler.python_generator/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jareferencecppapi-docsgoogleprotobufcompilerpython_generator><span></span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jareferencecppapi-docsgoogleprotobufcompilerruby_generator-li><a href=/ja/reference/cpp/api-docs/google.protobuf.compiler.ruby_generator/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jareferencecppapi-docsgoogleprotobufcompilerruby_generator><span></span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jareferencecppapi-docsgoogleprotobufdescriptorpb-li><a href=/ja/reference/cpp/api-docs/google.protobuf.descriptor.pb/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jareferencecppapi-docsgoogleprotobufdescriptorpb><span></span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jareferencecppapi-docsgoogleprotobufdynamic_message-li><a href=/ja/reference/cpp/api-docs/google.protobuf.dynamic_message/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jareferencecppapi-docsgoogleprotobufdynamic_message><span></span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jareferencecppapi-docsgoogleprotobufutilfield_comparator-li><a href=/ja/reference/cpp/api-docs/google.protobuf.util.field_comparator/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jareferencecppapi-docsgoogleprotobufutilfield_comparator><span></span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jareferencecppapi-docsgoogleprotobufutiljson_util-li><a href=/ja/reference/cpp/api-docs/google.protobuf.util.json_util/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jareferencecppapi-docsgoogleprotobufutiljson_util><span></span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jareferencecppapi-docsgoogleprotobufutiltype_resolver-li><a href=/ja/reference/cpp/api-docs/google.protobuf.util.type_resolver/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jareferencecppapi-docsgoogleprotobufutiltype_resolver><span></span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jareferencecppapi-docsgoogleprotobufutiltype_resolver_util-li><a href=/ja/reference/cpp/api-docs/google.protobuf.util.type_resolver_util/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jareferencecppapi-docsgoogleprotobufutiltype_resolver_util><span></span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-jareferencecsharp-li><a href=/ja/reference/csharp/ title="C# リファレンス" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-jareferencecsharp><span>C#</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jareferencecsharpcsharp-generated-li><a href=/ja/reference/csharp/csharp-generated/ title="C# 生成コードガイド" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jareferencecsharpcsharp-generated><span>生成コードガイド</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jareferencecsharpapi-docs-link-li><a href=/reference/csharp/api-docs target=_blank rel=noopener class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jareferencecsharpapi-docs-link><span>C# API</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-jareferencedart-li><a href=/ja/reference/dart/ title="Dart リファレンス" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-jareferencedart><span>Dart</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jareferencedartdart-generated-li><a href=/ja/reference/dart/dart-generated/ title="Dart Generated Code" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jareferencedartdart-generated><span>生成されたコード</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jareferencedartapi-docs-link-li><a href=https://pub.dartlang.org/documentation/protobuf target=_blank rel=noopener class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jareferencedartapi-docs-link><span>Dart API</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-jareferencego-li><a href=/ja/reference/go/ title=Goリファレンス class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-jareferencego><span>Go</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jareferencegogo-generated-li><a href=/ja/reference/go/go-generated/ title="Go Generated Code Guide" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jareferencegogo-generated><span>生成されたコードガイド</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jareferencegoapi-docs-link-li><a href=https://pkg.go.dev/google.golang.org/protobuf/proto target=_blank rel=noopener class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jareferencegoapi-docs-link><span>Go API</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jareferencegofaq-li><a href=/ja/reference/go/faq/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jareferencegofaq><span></span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jareferencegosize-li><a href=/ja/reference/go/size/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jareferencegosize><span></span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-jareferencejava-li><a href=/ja/reference/java/ title="Java リファレンス" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-jareferencejava><span>Java</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jareferencejavajava-generated-li><a href=/ja/reference/java/java-generated/ title=Java生成コードガイド class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jareferencejavajava-generated><span>生成コードガイド</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jareferencejavajava-proto-names-li><a href=/ja/reference/java/java-proto-names/ title="Java Proto Names" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jareferencejavajava-proto-names><span>生成されたProto名</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jareferencejavaapi-docs-link-li><a href=/reference/java/api-docs/overview-summary.html target=_blank rel=noopener class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jareferencejavaapi-docs-link><span>Java API</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-jareferencekotlin-li><a href=/ja/reference/kotlin/ title="Kotlin リファレンス" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-jareferencekotlin><span>Kotlin</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jareferencekotlinapi-docs-li><a href=/ja/reference/kotlin/api-docs/ title="Kotlin リファレンス" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-jareferencekotlinapi-docs><span>Kotlin</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jareferencekotlinkotlin-generated-li><a href=/ja/reference/kotlin/kotlin-generated/ title="Kotlin 生成コードガイド" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jareferencekotlinkotlin-generated><span>生成コードガイド</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-jareferenceobjective-c-li><a href=/ja/reference/objective-c/ title="Objective-C リファレンス" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-jareferenceobjective-c><span>Objective-C</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jareferenceobjective-cobjective-c-generated-li><a href=/ja/reference/objective-c/objective-c-generated/ title="Objective-C 生成コードガイド" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jareferenceobjective-cobjective-c-generated><span>生成コードガイド</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-jareferencephp-li><a href=/ja/reference/php/ title="PHP リファレンス" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-jareferencephp><span>PHP</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jareferencephpphp-generated-li><a href=/ja/reference/php/php-generated/ title="PHP 生成コードガイド" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jareferencephpphp-generated><span>生成コードガイド</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jareferencephpapi-docs-link-li><a href=/reference/php/api-docs/ target=_blank rel=noopener class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jareferencephpapi-docs-link><span>PHP API</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-jareferencepython-li><a href=/ja/reference/python/ title="Python リファレンス" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-jareferencepython><span>Python</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jareferencepythonpython-generated-li><a href=/ja/reference/python/python-generated/ title="Python 生成コードガイド" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jareferencepythonpython-generated><span>生成コードガイド</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jareferencepythonapi-docs-link-li><a href=https://googleapis.dev/python/protobuf/latest/ target=_blank rel=noopener class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jareferencepythonapi-docs-link><span>Python API</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-jareferenceruby-li><a href=/ja/reference/ruby/ title="Ruby リファレンス" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-jareferenceruby><span>Ruby</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jareferencerubyruby-generated-li><a href=/ja/reference/ruby/ruby-generated/ title="Ruby Generated Code Guide" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jareferencerubyruby-generated><span>生成されたコードガイド</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-jareferenceprotobuf-li><a href=/ja/reference/protobuf/ title=プロトコルバッファリファレンス class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-jareferenceprotobuf><span>プロトコルバッファ</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jareferenceprotobufedition-2023-spec-li><a href=/ja/reference/protobuf/edition-2023-spec/ title="Protocol Buffers Edition 2023 言語仕様" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jareferenceprotobufedition-2023-spec><span>2023 言語仕様</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jareferenceprotobufproto2-spec-li><a href=/ja/reference/protobuf/proto2-spec/ title="Protocol Buffers Version 2 言語仕様" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jareferenceprotobufproto2-spec><span>Version 2 言語仕様</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jareferenceprotobufproto3-spec-li><a href=/ja/reference/protobuf/proto3-spec/ title="Protocol Buffers Version 3 言語仕様" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jareferenceprotobufproto3-spec><span>Version 3 言語仕様</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jareferenceprotobuftextformat-spec-li><a href=/ja/reference/protobuf/textformat-spec/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jareferenceprotobuftextformat-spec><span>テキスト形式言語仕様</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jareferenceprotobufgoogleprotobuf-li><a href=/ja/reference/protobuf/google.protobuf/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jareferenceprotobufgoogleprotobuf><span></span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jareferenceother-li><a href=/ja/reference/other/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jareferenceother><span></span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-jasupport-li><a href=/ja/support/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-jasupport><span>サポート</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jasupportversion-support-li><a href=/ja/support/version-support/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jasupportversion-support><span>バージョンサポート</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jasupportcross-version-runtime-guarantee-li><a href=/ja/support/cross-version-runtime-guarantee/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jasupportcross-version-runtime-guarantee><span>クロスバージョンランタイム保証</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jasupportmigration-li><a href=/ja/support/migration/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jasupportmigration><span></span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jaforum-link-li><a href=https://groups.google.com/g/protobuf target=_blank rel=noopener class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jaforum-link><span>フォーラム</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jadownloads-li><a href=/ja/downloads/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jadownloads><span></span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jahistory-li><a href=/ja/history/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jahistory><span></span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-janavbar-li><a href=/ja/navbar/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-janavbar><span></span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-jasearch-li><a href=/ja/search/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-jasearch><span>検索結果</span></a></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/protocolbuffers/protocolbuffers.github.io/tree/main/content/programming-guides/api.ja.md class=td-page-meta--view target=_blank rel=noopener><i class="fa-solid fa-file-lines fa-fw"></i> View page source</a>
<a href=https://github.com/protocolbuffers/protocolbuffers.github.io/edit/main/content/programming-guides/api.ja.md class=td-page-meta--edit target=_blank rel=noopener><i class="fa-solid fa-pen-to-square fa-fw"></i> ページの編集</a>
<a href="https://github.com/protocolbuffers/protocolbuffers.github.io/new/main/content/programming-guides/api.ja.md?filename=change-me.md&amp;value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" class=td-page-meta--child target=_blank rel=noopener><i class="fa-solid fa-pen-to-square fa-fw"></i> 子ページを作成</a>
<a href="https://github.com/protocolbuffers/protocolbuffers.github.io/issues/new?title=API%20%e3%83%99%e3%82%b9%e3%83%88%e3%83%97%e3%83%a9%e3%82%af%e3%83%86%e3%82%a3%e3%82%b9" class=td-page-meta--issue target=_blank rel=noopener><i class="fa-solid fa-list-check fa-fw"></i> ドキュメントのissueを作成</a>
<a href=https://github.com/protocolbuffers/protobuf/issues/new class=td-page-meta--project-issue target=_blank rel=noopener><i class="fa-solid fa-list-check fa-fw"></i> プロジェクトのissueを作成</a></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#precisely-concisely>正確かつ簡潔にフィールドとメッセージを文書化する</a></li><li><a href=#use-different-messages>ワイヤーとストレージ用に異なるメッセージを使用する</a></li><li><a href=#support-partial-updates>ミューテーションについて、部分更新または追加のみの更新をサポートし、完全な置換を行わない</a><ul><li><a href=#use-update-field-mask>修正方法1: Update Field-mask を使用する</a></li><li><a href=#expose-more-narrow-mutations>修正方法2: 個々の部分を変更するより狭いミューテーションを公開する</a></li></ul></li><li><a href=#dont-include-primitive-types>トップレベルのリクエストまたはレスポンスプロトにプリミティブ型を含めないでください</a></li><li><a href=#never-use-booleans-for-two-states>2 つの状態を持つものにブール値を使用しない</a></li><li><a href=#integer-field-for-id>ID に整数フィールドをほとんど使用しない</a></li><li><a href=#dont-encode-data-in-a-string>クライアントが構築または解析することを期待する文字列にデータをエンコードしない</a><ul><li><a href=#returning-html>フロントエンドプロトでHTMLを返す</a></li></ul></li><li><a href=#encode-opaque-data-in-strings>文字列中の不透明データを Web セーフエンコードバイナリ Proto シリアライゼーション</a></li><li><a href=#dont-include-fields>クライアントが絶対に使用しないフィールドを含めない</a></li><li><a href=#define-pagination-api><em>稀に</em> 継続トークンなしでページネーションAPIを定義しない</a></li><li><a href=#group-related-fields>関連するフィールドを新しいメッセージにグループ化します。高い結合度を持つフィールドのみをネストします</a></li><li><a href=#include-field-read-mask>読み取りリクエストにフィールド読み取りマスクを含める</a></li><li><a href=#include-version-field>一貫した読み取りを可能にするためにバージョンフィールドを含める</a></li><li><a href=#use-consistent-request-options>同じデータ型を返す RPC に対して一貫したリクエストオプションを使用する</a></li><li><a href=#batch-multi-phase-requests>バッチ/マルチフェーズリクエスト</a></li><li><a href=#create-methods-manipulate-small-bits>小さなデータを返すか操作するメソッドを作成し、クライアントにUIを複数のリクエストからバッチ処理することを期待する</a></li><li><a href=#make-one-off-rpc>モバイルまたはWebでシリアルラウンドトリップの代替手段が1回限りのRPCを作成する場合</a></li><li><a href=#repeated-fields-messages-scalar-types>繰り返しフィールドのメッセージを作成し、スカラーまたは列挙型ではなく</a></li><li><a href=#use-proto-maps>Proto Maps の使用</a></li><li><a href=#prefer-idempotency>冪等性を好む</a></li><li><a href=#service-name-globally-unique>サービス名に注意し、グローバルに一意にする</a></li><li><a href=#every-rpc-deadline>すべての RPC に（寛容な）締め切りを指定して強制する</a></li><li><a href=#bound-req-res-sizes>リクエストとレスポンスのサイズを制限する</a></li><li><a href=#propagate-status-codes>ステータスコードを慎重に伝播する</a></li><li><a href=#unique-protos>各メソッドごとに固有のプロトを作成</a><ul><li><a href=#reuse-messages>メッセージの再利用</a></li></ul></li><li><a href=#appendix>付録</a><ul><li><a href=#returning-repeated-fields>繰り返しフィールドの返却</a></li><li><a href=#updating-repeated-fields>繰り返しフィールドの更新</a></li><li><a href=#order-independence-repeated-fields>繰り返しフィールドにおける順序の独立性</a></li><li><a href=#leaking-features>モバイルビルドでProtoが漏洩する機能</a></li><li><a href=#performance-optimizations>パフォーマンスの最適化</a></li></ul></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><nav aria-label=breadcrumb class=td-breadcrumbs><ol class=breadcrumb><li class=breadcrumb-item><a href=https://protobuf.dev/ja/programming-guides/>プログラミングガイド</a></li><li class="breadcrumb-item active" aria-current=page><a href=https://protobuf.dev/ja/programming-guides/api/ aria-disabled=true class="btn-link disabled">API ベストプラクティス</a></li></ol></nav><div class=td-content><h1>API ベストプラクティス</h1><div class=lead>将来に耐えうる API を作成するのは驚くほど難しいです。この文書の提案は、長期的でバグのない進化を優先するためにトレードオフを行います。</div><header class=article-meta></header><p>proto3 用に更新されました。パッチは歓迎します！</p><p>この文書は、<a href=/programming-guides/dos-donts>Proto ベストプラクティス</a> の補足です。
これは Java/C++/Go などの API の指針ではありません。</p><p>コードレビューでこれらのガイドラインから逸脱する proto を見つけた場合は、
著者にこのトピックを指摘し、情報を広めるのを手伝ってください。</p><div class="alert alert-note" role=alert><h4 class=alert-heading>Note</h4>これらのガイドラインはそれだけであり、多くの例外が文書化されています。たとえば、
パフォーマンスが重要なバックエンドを書いている場合、柔軟性や安全性を犠牲にして速度を上げたいかもしれません。
このトピックは、トレードオフをよりよく理解し、状況に適した決定をするのに役立ちます。</div><h2 id=precisely-concisely>正確かつ簡潔にフィールドとメッセージを文書化する</h2><p>おそらく、あなたの proto は、あなたがそれを書いたり変更したときに考えていたことを知らない人々によって継承され、使用されるでしょう。
各フィールドを、あなたのシステムの知識が少ない新しいチームメンバーやクライアントにとって有用な用語で文書化してください。</p><p>具体的な例:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Bad: Option to enable Foo
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Good: Configuration controlling the behavior of the Foo feature.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>FeatureFooConfig</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Bad: Sets whether the feature is enabled
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// Good: Required field indicating whether the Foo feature
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// is enabled for account_id.  Must be false if account_id&#39;s
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// FOO_OPTIN Gaia bit is not set.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>bool</span> <span style=color:#000>enabled</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic>// Bad: Foo object.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Good: Client-facing representation of a Foo (what/foo) exposed in APIs.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Foo</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Bad: Title of the foo.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// Good: Indicates the user-supplied title of this Foo, with no
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// normalization or escaping.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// An example title: &#34;Picture of my cat in a box &lt;3 &lt;3 !!!&#34;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>title</span> <span style=color:#000;font-weight:700>[(</span><span style=color:#000>max_length</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>512</span><span style=color:#000;font-weight:700>];</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic>// Bad: Foo config.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Less-Bad: If the most useful comment is re-stating the name, better to omit
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// the comment.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>FooConfig</span> <span style=color:#000>foo_config</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>各フィールドの制約、期待値、解釈を可能な限り簡潔に文書化してください。</p><p>カスタム proto アノテーションを使用することができます。
上記の例のように <code>max_length</code> のようなクロス言語定数を定義するには、
<a href=/programming-guides/proto2#options>カスタムオプション</a> を参照してください。
proto2 および proto3 でサポートされています。</p><p>インターフェースの文書化は時間とともに長くなることがあります。その長さは明瞭さを損ないます。
文書化が実際に不明確な場合は修正してくださいが、
全体的に見て簡潔さを目指してください。</p><h2 id=use-different-messages>ワイヤーとストレージ用に異なるメッセージを使用する</h2><p>クライアントに公開するトップレベルの proto がディスクに保存するものと同じであれば、問題が発生します。
時間の経過とともに、ますます多くのバイナリがあなたの API に依存するようになり、変更が難しくなります。
ストレージ形式を変更する自由を持ち、クライアントに影響を与えることなくストレージ形式を変更できるようにしてください。
モジュールがクライアントプロト、ストレージプロト、または翻訳といったものに対応するようにコードをレイヤー化してください。</p><p>なぜかというと、基礎となるストレージシステムを交換したいかもしれません。データを正規化したり非正規化したりしたいかもしれません。クライアントに公開される proto の一部を RAM に保存することが合理的である一方、他の部分はディスクに保存することが合理的であることに気づくかもしれません。</p><p>トップレベルのリクエストまたはレスポンス内に1つ以上のレベルでネストされた proto に関しては、ストレージとワイヤー proto を分離する理由はそれほど強くなく、クライアントをそれらの proto にどれだけ密接に結びつけるかに依存します。</p><p>翻訳レイヤーを維持するコストはかかりますが、クライアントがいて最初のストレージ変更を行う必要があるとすぐにペイオフします。</p><p>必要に応じて proto を共有して「必要なときに」分岐することに誘惑されるかもしれません。分岐に高いコストがかかり、内部フィールドを配置する明確な場所がない場合、API はクライアントが理解しないフィールドを蓄積したり、知識を持たずに依存したりする可能性があります。</p><p>別々の proto ファイルから始めることで、チームは API を汚染せずに内部フィールドを追加する場所を知ることができます。初期段階では、ワイヤー proto は自動翻訳レイヤー（バイトコピーまたは proto リフレクションなど）とタグごとに同一であることができます。Proto アノテーションも自動翻訳レイヤーをサポートできます。</p><p>以下はルールの例外です：</p><ul><li>もし proto フィールドが <code>google.type</code> または <code>google.protobuf</code> のような一般的なタイプの1つである場合、そのタイプをストレージと API の両方で使用することは許容されます。</li><li>サービスが非常にパフォーマンスに敏感である場合、柔軟性を実行速度と引き換える価値があるかもしれません。サービスがミリ秒単位のレイテンシで数百万の QPS を持っていない場合、おそらく例外ではありません。</li><li>すべての以下が真である場合：<ul><li>あなたのサービスはストレージシステムである</li><li>あなたのシステムはクライアントの構造化データに基づいて決定を行わない</li><li>あなたのシステムは単にクライアントのリクエストに応じてデータを保存、読み込み、およびクエリを提供する</li></ul></li></ul><p>ログシステムや一般的なストレージシステムをラップする proto ベースのラッパーなどを実装している場合、クライアントのメッセージができるだけ不透明にストレージバックエンドに移行するようにすることで依存関係のネクサスを作成しないようにすることが重要です。拡張機能や<a href=/programming-guides/api#encode-opaque-data-in-strings>Web セーフ エンコーディング バイナリ Proto シリアル化による文字列内の不透明データのエンコード</a>を使用することを検討してください。</p><h2 id=support-partial-updates>ミューテーションについて、部分更新または追加のみの更新をサポートし、完全な置換を行わない</h2><p><code>Foo</code> のみを取る <code>UpdateFooRequest</code> を作成しないでください。</p><p>クライアントが未知のフィールドを保持しない場合、<code>GetFooResponse</code> の最新のフィールドを持たないため、ラウンドトリップでデータが失われる可能性があります。一部のシステムは未知のフィールドを保持しません。Proto2 および proto3 の実装は、アプリケーションが未知のフィールドを明示的に削除しない限り、未知のフィールドを保持します。一般的に、公開APIでは、セキュリティ攻撃を防ぐために、未知のフィールドをサーバーサイドで削除する必要があります。たとえば、ゴミの未知のフィールドが将来の新しいフィールドとして使用されるとサーバーが失敗する可能性があります。</p><p>ドキュメントがない場合、オプションフィールドの処理は曖昧です。<code>UpdateFoo</code> はフィールドをクリアしますか？その場合、クライアントがそのフィールドについて知らないとデータが失われる可能性があります。フィールドに触れないのでしょうか？その場合、クライアントはフィールドをクリアする方法はありませんか？どちらもよくありません。</p><h3 id=use-update-field-mask>修正方法1: Update Field-mask を使用する</h3><p>クライアントに修正したいフィールドを渡し、更新リクエストにはそれらのフィールドのみを含めます。サーバーは他のフィールドをそのままにし、マスクで指定されたフィールドのみを更新します。
一般的に、マスクの構造はレスポンスプロトの構造を反映すべきです。つまり、<code>Foo</code> が <code>Bar</code> を含む場合、<code>FooMask</code> は <code>BarMask</code> を含むべきです。</p><h3 id=expose-more-narrow-mutations>修正方法2: 個々の部分を変更するより狭いミューテーションを公開する</h3><p>たとえば、<code>UpdateEmployeeRequest</code> の代わりに、<code>PromoteEmployeeRequest</code>、<code>SetEmployeePayRequest</code>、<code>TransferEmployeeRequest</code> などがあるかもしれません。</p><p>カスタムの更新メソッドは、非常に柔軟な更新メソッドよりも監視、監査、セキュリティが容易です。また、実装や呼び出しも簡単です。<em>多く</em>のメソッドは、APIの認知負荷を増加させる可能性があります。</p><h2 id=dont-include-primitive-types>トップレベルのリクエストまたはレスポンスプロトにプリミティブ型を含めないでください</h2><p>このルールによって、このドキュメントの他の場所で説明されている多くの落とし穴が解決されます。
たとえば：</p><p>クライアントに、繰り返しフィールドがストレージに未設定であることを伝えるか、この特定の呼び出しで未設定であるかを伝えることは、繰り返しフィールドをメッセージでラップすることで行うことができます。</p><p>共通のリクエストオプションは、リクエスト間で共有されるため、このルールに従うことが自然になります。読み取りおよび書き込みフィールド マスクは、このルールから外れます。</p><p>トップレベルの proto は、ほとんどの場合、独立して成長できる他のメッセージのコンテナであるべきです。</p><p>今日は単一のプリミティブ型のみが必要な場合でも、その型をメッセージでラップすることで、その型を拡張し、同様の値を返す他のメソッド間でその型を共有する明確なパスが得られます。例:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>MultiplicationResponse</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Bad: What if you later want to return complex numbers and have an
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// AdditionResponse that returns the same multi-field type?
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>double</span> <span style=color:#000>result</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Good: Other methods can share this type and it can grow as your
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// service adds new features (units, confidence intervals, etc.).
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>NumericResult</span> <span style=color:#000>result</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>NumericResult</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>double</span> <span style=color:#000>real_value</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>double</span> <span style=color:#000>complex_value</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>UnitType</span> <span style=color:#000>units</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>トップレベルのプリミティブの例外: サーバーでのみ構築および解析される構造化された proto をエンコードする不透明な文字列（またはバイト）。継続トークン、バージョン情報トークン、および ID は、文字列として返される可能性があります <em>もし</em> その文字列が実際に構造化された proto のエンコーディングである場合。</p><h2 id=never-use-booleans-for-two-states>2 つの状態を持つものにブール値を使用しない</h2><p>フィールドにブール値を使用している場合は、そのフィールドが確かに常に 2 つの可能な状態を表していることを確認してください（現在だけでなく、将来も含む）。しばしば、列挙型、int、またはメッセージの柔軟性が価値があることがわかります。</p><p>例えば、開発者が投稿のストリームを返す際に、現在の UX のモックに基づいて投稿を 2 列にレンダリングするかどうかを示す必要があるかもしれません。今日必要なのはブール値だけですが、将来のバージョンで 2 行の投稿、3 列の投稿、または 4 つの正方形の投稿を導入する可能性があります。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>GooglePlusPost</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Bad: Whether to render this post across two columns.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>bool</span> <span style=color:#000>big_post</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Good: Rendering hints for clients displaying this post.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// Clients should use this to decide how prominently to render this
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// post. If absent, assume a default rendering.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>LayoutConfig</span> <span style=color:#000>layout_config</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Photo</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Bad: True if it&#39;s a GIF.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>bool</span> <span style=color:#000>gif</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Good: File format of the referenced photo (for example, GIF, WebP, PNG).
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>PhotoType</span> <span style=color:#000>type</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>概念を混同する列挙型に状態を追加する際は注意してください。</p><p>状態が列挙型に新しい次元を導入するか、複数のアプリケーション動作を示唆する場合、おそらく別のフィールドが必要です。</p><h2 id=integer-field-for-id>ID に整数フィールドをほとんど使用しない</h2><p>オブジェクトの識別子として int64 を使用することは魅力的ですが、代わりに文字列を選択してください。</p><p>これにより、必要に応じて ID スペースを変更でき、衝突の可能性が低下します。2^64 は以前ほど大きくありません。</p><p>また、クライアントがそれを不透明なブロブとして扱うように促す構造化された識別子を文字列としてエンコードすることもできます。文字列のフィールドに proto をシリアライズできます（Web セーフな Base64 としてエンコードされます）、これにより、クライアントに公開される API から内部の詳細を削除できます。この場合は、以下のガイドラインに従ってください <a href=#encode-opaque-data-in-strings>below</a>。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>GetFooRequest</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Which Foo to fetch.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>foo_id</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic>// Serialized and websafe-base64-encoded into the GetFooRequest.foo_id field.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>InternalFooRef</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Only one of these two is set. Foos that have already been
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// migrated use the spanner_foo_id and Foos still living in
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// Caribou Storage Server have a classic_foo_id.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>bytes</span> <span style=color:#000>spanner_foo_id</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>int64</span> <span style=color:#000>classic_foo_id</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>自分自身のシリアル化スキームを使用してIDを文字列で表現し始めると、すぐに奇妙なことが起こります。そのため、文字列フィールドをバックアップする内部プロトで開始するのが最善です。</p><h2 id=dont-encode-data-in-a-string>クライアントが構築または解析することを期待する文字列にデータをエンコードしない</h2><p>これは、ワイヤーを介して効率が悪く、プロトの消費者にとってはより多くの作業が必要で、ドキュメントを読む人にとっては混乱を招きます。クライアントはエンコーディングについても考えなければなりません: リストはカンマで区切られていますか？この信頼できないデータを正しくエスケープしましたか？数字は10進数ですか？クライアントが実際のメッセージまたはプリミティブ型を送信する方が良いです。ワイヤーを介してよりコンパクトで、クライアントにとってもより明確です。</p><p>特に、サービスが複数の言語でクライアントを取得する場合は、状況が悪化します。今度は、各言語が適切なパーサーまたはビルダーを選択しなければならないか、さらに悪いことには、それを書かなければなりません。</p><p>一般的に、適切なプリミティブ型を選択してください。<a href=/programming-guides/proto2#scalar>Protocol Buffer Language Guide</a>のScalar Value Typesテーブルを参照してください。</p><h3 id=returning-html>フロントエンドプロトでHTMLを返す</h3><p>JavaScriptクライアントでは、APIのフィールドにHTMLまたはJSONを返すことが魅力的です。これは、APIを特定のUIに結びつける滑りやすい坂になります。次の3つの具体的な危険があります:</p><ul><li>&ldquo;手作り"の非Webクライアントは、望むデータを取得するためにHTMLまたはJSONを解析することになり、フォーマットを変更した場合には脆弱性が生じ、解析が悪い場合には壊れやすくなります。</li><li>Webクライアントは、返されたHTMLが無加工で返された場合、XSS攻撃の脆弱性が生じます。</li><li>返されるタグとクラスは特定のスタイルシートとDOM構造を想定しています。リリースごとにその構造が変わり、JavaScriptクライアントがサーバーよりも古い場合に、サーバーが返すHTMLが古いクライアントで正しくレンダリングされなくなるバージョンのずれの問題が発生します。頻繁にリリースするプロジェクトでは、これはエッジケースではありません。</li></ul><p>初期のページ読み込み以外では、通常はデータを返し、クライアント側のテンプレートを使用してクライアントでHTMLを構築する方が良いでしょう。</p><h2 id=encode-opaque-data-in-strings>文字列中の不透明データを Web セーフエンコードバイナリ Proto シリアライゼーション</h2><p>もしクライアントが見る可能性のあるフィールド（継続トークン、シリアライズされた ID、バージョン情報など）に<em>不透明</em>データをエンコードする場合は、クライアントがそれを不透明なブロブとして扱うように文書化してください。<em>これらのフィールドには、テキスト形式や独自の形式ではなく、常にバイナリ Proto シリアライゼーションを使用してください。</em> 不透明フィールドにエンコードされたデータを展開する必要がある場合、すでにそれを使用していない場合は、プロトコルバッファシリアライゼーションを再発明することになります。</p><p>不透明フィールドに入るフィールドを保持する内部 Proto を定義し（1つのフィールドしか必要がなくても）、この内部 Proto をバイトにシリアライズしてから、その結果を Web セーフな Base64 エンコードして文字列フィールドに入れてください。</p><p>Proto シリアライゼーションを使用しないまれな例外: <em>非常に</em>まれに、注意深く構築された代替形式からのコンパクト性が勝る場合があります。</p><h2 id=dont-include-fields>クライアントが絶対に使用しないフィールドを含めない</h2><p>クライアントに公開する API は、システムとのやり取り方法を説明するためだけにするべきです。それ以外のものを含めると、理解しようとする人に認知的負荷がかかります。</p><p>応答プロトでデバッグデータを返すことは以前一般的な慣行でしたが、より良い方法があります。RPC 応答拡張（または「サイドチャネル」とも呼ばれる）を使用すると、クライアントインターフェースを1つの Proto で、デバッグ用のサーフェスを別の Proto で記述できます。</p><p>同様に、応答プロトで実験名を返すことは以前はログ記録の便宜上でした&ndash;書かれていない契約は、クライアントがその実験を後続のアクションで送信することでした。同じことを達成する受け入れられる方法は、解析パイプラインでログ結合を行うことです。</p><p>1つの例外:</p><p>連続してリアルタイムの分析が必要で、かつ小さなマシン予算である場合、ログ結合を実行することが制限されるかもしれません。
コストが決定要因である場合、事前にログデータを非正規化することが有利になるかもしれません。ログデータをラウンドトリップで送信する必要がある場合は、それをクライアントに不透明なブロブとして送信し、リクエストと応答フィールドを文書化してください。</p><p><strong>注意:</strong> サービスの使用コストを隠してしまうと、<em>すべての</em>リクエストで非表示データを返したりラウンドトリップしたりする必要がある場合、それはサービスの使用コストを隠してしまうことになり、それもよくありません。</p><h2 id=define-pagination-api><em>稀に</em> 継続トークンなしでページネーションAPIを定義しない</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>FooQuery</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Bad: If the data changes between the first query and second, each of
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// these strategies can cause you to miss results. In an eventually
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// consistent world (that is, storage backed by Bigtable), it&#39;s not uncommon
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// to have old data appear after the new data. Also, the offset- and
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// page-based approaches all assume a sort-order, taking away some
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// flexibility.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>int64</span> <span style=color:#000>max_timestamp_ms</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>result_offset</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>page_number</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>page_size</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Good: You&#39;ve got flexibility! Return this in a FooQueryResponse and
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// have clients pass it back on the next query.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>next_page_token</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>ページネーションAPIのベストプラクティスは、内部プロトによってバックアップされた不透明な継続トークン（<code>next_page_token</code>と呼ばれる）を使用し、それをシリアライズしてから <code>WebSafeBase64Escape</code>（C++）または <code>BaseEncoding.base64Url().encode</code>（Java）します。その内部プロトには多くのフィールドが含まれているかもしれません。重要なのは、これによって柔軟性が得られることと、必要に応じてクライアントに安定性が提供されることです。</p><p>このプロトのフィールドを信頼できない入力として検証することを忘れないでください（<a href=#encode-opaque-data-in-strings>文字列で不透明なデータをエンコードする</a>の注を参照）。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>InternalPaginationToken</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Track which IDs have been seen so far. This gives perfect recall at the
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// expense of a larger continuation token--especially as the user pages
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// back.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#000>FooRef</span> <span style=color:#000>seen_ids</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Similar to the seen_ids strategy, but puts the seen_ids in a Bloom filter
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// to save bytes and sacrifice some precision.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>bytes</span> <span style=color:#000>bloom_filter</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// A reasonable first cut and it may work for longer. Having it embedded in
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// a continuation token lets you change it later without affecting clients.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>int64</span> <span style=color:#000>max_timestamp_ms</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><h2 id=group-related-fields>関連するフィールドを新しいメッセージにグループ化します。高い結合度を持つフィールドのみをネストします</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Foo</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Bad: The price and currency of this Foo.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>int</span> <span style=color:#000>price</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>CurrencyType</span> <span style=color:#000>currency</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Better: Encapsulates the price and currency of this Foo.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>CurrencyAmount</span> <span style=color:#000>price</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>高い結合度を持つフィールドのみをネストすべきです。フィールドが本当に関連している場合、サーバ内で一緒に渡すことが多いでしょう。それらがメッセージ内で一緒に定義されていると、それが簡単になります。考えてみてください：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>CurrencyAmount</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>calculateLocalTax</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>CurrencyAmount</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>price</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Location</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>where</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>CLが1つのフィールドを導入する場合でも、そのフィールドに後で関連するフィールドが追加される可能性がある場合は、予防的に独自のメッセージに配置して、次のような状況を避けてください：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Foo</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// DEPRECATED! Use currency_amount.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>int</span> <span style=color:#000>price</span> <span style=color:#000;font-weight:700>[</span><span style=color:#000>deprecated</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>];</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// The price and currency of this Foo.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>google.type.Money</span> <span style=color:#000>currency_amount</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>ネストされたメッセージの問題は、<code>CurrencyAmount</code>がAPIの他の場所で再利用される可能性がある一方で、<code>Foo.CurrencyAmount</code>が再利用されないかもしれないことです。最悪の場合、<code>Foo.CurrencyAmount</code>が再利用されるが、<code>Foo</code> 固有のフィールドが漏れ込む可能性があります。</p><p><a href=https://en.wikipedia.org/wiki/Loose_coupling>緩やかな結合</a>は、システムを開発する際のベストプラクティスとして一般的に受け入れられていますが、<code>.proto</code> ファイルを設計する際には常に適用されるわけではありません。情報の2つのユニットを（1つをもう一方の内部にネストすることで）緊密に結合することが意味をなす場合もあります。たとえば、現時点ではかなり汎用的に見える一連のフィールドを作成しているが、後で専門のフィールドを追加することを予想している場合、メッセージをネストすることで、他の場所の他の<code>.proto</code> ファイルでそのメッセージを参照することを避けることができます。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Photo</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Bad: It&#39;s likely PhotoMetadata will be reused outside the scope of Photo,
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// so it&#39;s probably a good idea not to nest it and make it easier to access.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>PhotoMetadata</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>    <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>width</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>    <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>height</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>PhotoMetadata</span> <span style=color:#000>metadata</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>FooConfiguration</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Good: Reusing FooConfiguration.Rule outside the scope of FooConfiguration
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// tightly-couples it with likely unrelated components, nesting it dissuades
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// from doing that.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Rule</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>    <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>float</span> <span style=color:#000>multiplier</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#000>Rule</span> <span style=color:#000>rules</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><h2 id=include-field-read-mask>読み取りリクエストにフィールド読み取りマスクを含める</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Recommended: use google.protobuf.FieldMask
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic>// Alternative one:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>FooReadMask</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>bool</span> <span style=color:#000>return_field1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>bool</span> <span style=color:#000>return_field2</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic>// Alternative two:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>BarReadMask</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Tag numbers of the fields in Bar to return.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>fields_to_return</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>推奨される <code>google.protobuf.FieldMask</code> を使用すると、<code>FieldMaskUtil</code>
(<a href=/reference/java/api-docs/com/google/protobuf/util/FieldMaskUtil.html>Java</a>/<a href=/reference/cpp/api-docs/google.protobuf.util.field_mask_util.md>C++</a>)
ライブラリを使用して、proto を自動的にフィルタリングできます。</p><p>読み取りマスクはクライアント側に明確な期待を設定し、クライアントが返されるデータ量を制御し、バックエンドがクライアントが必要とするデータのみを取得できるようにします。</p><p>許容される代替手段は常にすべてのフィールドを埋めることです。つまり、すべてのフィールドが true に設定された暗黙の読み取りマスクがあるかのようにリクエストを処理します。これは、proto が成長するにつれてコストがかかる可能性があります。</p><p>最悪の失敗モードは、メッセージを生成したメソッドによって異なる暗黙の（宣言されていない）読み取りマスクがあることです。このアンチパターンは、応答 proto からローカルキャッシュを構築するクライアントで明らかなデータ損失につながります。</p><h2 id=include-version-field>一貫した読み取りを可能にするためにバージョンフィールドを含める</h2><p>クライアントが同じオブジェクトに書き込みを行い、その後読み取りを行う場合、クライアントは書き込んだ内容を取得することを期待します。この期待が基礎となるストレージシステムにとって合理的でない場合でも同様です。</p><p>サーバーはローカル値を読み取り、ローカルの version_info が期待される version_info よりも小さい場合、最新の値を見つけるためにリモートレプリカから読み取ります。通常、version_info は、ミューテーションが行われたデータセンターとコミットされたタイムスタンプを含む文字列としてエンコードされた
<a href=#encode-opaque-data-in-strings>proto</a>です。</p><p>一貫したストレージでバックアップされたシステムでも、毎回の読み取りでコストをかけるのではなく、より高価な一貫した読み取りパスをトリガーするトークンが必要な場合があります。</p><h2 id=use-consistent-request-options>同じデータ型を返す RPC に対して一貫したリクエストオプションを使用する</h2><p>各 RPC が同じデータ型を返すサービスのリクエストオプションには、最大コメント数やサポートされる埋め込みタイプリストなどを指定するための別々のリクエストオプションがあるが、それぞれの RPC に対して異なるリクエストオプションがあるというのは、例の失敗パターンです。</p><p>コストをかけずにアプローチすることのコストは、各リクエストをどのように記入するかを把握することによるクライアントの複雑さと、N個のリクエストオプションを共通の内部オプションに変換することによるサーバーの複雑さが増加します。実際のバグのかなりの数は、この例に起因するものです。</p><p>代わりに、リクエストオプションを保持する単一の別のメッセージを作成し、それを各トップレベルのリクエストメッセージに含めます。以下は、ベストプラクティスの例です：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>FooRequestOptions</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Field-level read mask of which fields to return. Only fields that
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// were requested will be returned in the response. Clients should only
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// ask for fields they need to help the backend optimize requests.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>FooReadMask</span> <span style=color:#000>read_mask</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Up to this many comments will be returned on each Foo in the response.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// Comments that are marked as spam don&#39;t count towards the maximum
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// comments. By default, no comments are returned.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>int</span> <span style=color:#000>max_comments_to_return</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Foos that include embeds that are not on this supported types list will
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// have the embeds down-converted to an embed specified in this list. If no
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// supported types list is specified, no embeds will be returned. If an embed
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// can&#39;t be down-converted to one of the supplied supported types, no embed
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// will be returned. Clients are strongly encouraged to always include at
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// least the THING_V2 embed type from EmbedTypes.proto.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#000>EmbedType</span> <span style=color:#000>embed_supported_types_list</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>GetFooRequest</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// What Foo to read. If the viewer doesn&#39;t have access to the Foo or the
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// Foo has been deleted, the response will be empty but will succeed.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>foo_id</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Clients are required to include this field. Server returns
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// INVALID_ARGUMENT if FooRequestOptions is left empty.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>FooRequestOptions</span> <span style=color:#000>params</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>ListFooRequest</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Which Foos to return. Searches have 100% recall, but more clauses
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// impact performance.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>FooQuery</span> <span style=color:#000>query</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Clients are required to include this field. The server returns
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// INVALID_ARGUMENT if FooRequestOptions is left empty.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>FooRequestOptions</span> <span style=color:#000>params</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><h2 id=batch-multi-phase-requests>バッチ/マルチフェーズリクエスト</h2><p>可能な限り、変更をアトミックに行います。さらに重要なのは、<a href=#prefer-idempotency>変更を冪等性にすること</a>です。部分的な失敗の完全な再試行は、データの破損/重複を引き起こすべきではありません。</p><p>時折、パフォーマンス上の理由から複数の操作をカプセル化する単一のRPCが必要になることがあります。部分的な失敗が発生した場合はどうすればよいでしょうか？一部が成功し、一部が失敗した場合、クライアントに通知するのが最善です。</p><p>RPCを失敗として設定し、成功と失敗の両方の詳細をRPCステータスプロトに返します。</p><p>一般的に、部分的な失敗の処理について無知なクライアントでも正しく動作するようにし、部分的な失敗の処理について知っているクライアントには追加価値を提供します。</p><h2 id=create-methods-manipulate-small-bits>小さなデータを返すか操作するメソッドを作成し、クライアントにUIを複数のリクエストからバッチ処理することを期待する</h2><p>1回のラウンドトリップで多くの狭く指定されたデータをクエリできる能力は、クライアントが必要なものを構築できるようにすることで、サーバーの変更なしにより広範囲のUXオプションを提供します。</p><p>これは、フロントエンドとミドルティアサーバーに最も関連しています。</p><p>多くのサービスは独自のバッチAPIを公開しています。</p><h2 id=make-one-off-rpc>モバイルまたはWebでシリアルラウンドトリップの代替手段が1回限りのRPCを作成する場合</h2><p><em>Webまたはモバイル</em>クライアントが2つのクエリを行い、それらの間にデータ依存関係がある場合、現在のベストプラクティスは、クライアントをラウンドトリップから保護する新しいRPCを作成することです。</p><p>モバイルの場合、2つのサービスメソッドを1つにまとめて新しいメソッドに組み込むことで、クライアントに余分なラウンドトリップのコストをかける価値がほぼ常にあります。サーバー間の呼び出しの場合、状況は明確でないかもしれません。サービスがどれだけパフォーマンスに敏感か、新しいメソッドがどれだけ認知的負荷を導入するかに依存します。</p><h2 id=repeated-fields-messages-scalar-types>繰り返しフィールドのメッセージを作成し、スカラーまたは列挙型ではなく</h2><p>一般的な進化は、単一の繰り返しフィールドが複数の関連する繰り返しフィールドになる必要があるということです。繰り返しプリミティブから始める場合、選択肢は限られます&ndash;並行して繰り返しフィールドを作成するか、値を保持する新しいメッセージを持つ新しい繰り返しフィールドを定義し、クライアントをそれに移行させることになります。</p><p>繰り返しメッセージから始めると、進化は簡単になります。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Describes a type of enhancement applied to a photo
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>EnhancementType</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>ENHANCEMENT_TYPE_UNSPECIFIED</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>RED_EYE_REDUCTION</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>SKIN_SOFTENING</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>PhotoEnhancement</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>EnhancementType</span> <span style=color:#000>type</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>PhotoEnhancementReply</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Good: PhotoEnhancement can grow to describe enhancements that require
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// more fields than just an enum.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#000>PhotoEnhancement</span> <span style=color:#000>enhancements</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Bad: If we ever want to return parameters associated with the
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// enhancement, we&#39;d have to introduce a parallel array (terrible) or
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// deprecate this field and introduce a repeated message.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#000>EnhancementType</span> <span style=color:#000>enhancement_types</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>次の機能リクエストを想像してみてください: &ldquo;ユーザーによって実行された強化とシステムによって自動的に適用された強化を知る必要があります。&rdquo;</p><p>もし<code>PhotoEnhancementReply</code>の強化フィールドがスカラーまたは列挙型であれば、これをサポートするのははるかに難しいでしょう。</p><p>これはマップにも同様に適用されます。既にメッセージである場合、マップ値に追加のフィールドを追加することははるかに簡単です。<code>map&lt;string, string></code>から<code>map&lt;string, MyProto></code>に移行する必要があるよりも。</p><p>1つの例外:</p><p>レイテンシーが重要なアプリケーションでは、プリミティブ型の並行配列を構築および削除する方が、メッセージの単一の配列よりも速くなります。また、<a href=/programming-guides/encoding#packed>[packed=true]</a>（フィールドタグを省略する）を使用すると、ワイヤー上でより小さくなります。固定数の配列を割り当てる方が、N個のメッセージを割り当てるよりも少ない作業です。ボーナス: <a href=/programming-guides/proto3>Proto3</a>では、パッキングは自動的に行われます。明示的に指定する必要はありません。</p><h2 id=use-proto-maps>Proto Maps の使用</h2><p><a href=/programming-guides/proto3>Proto3</a>での<a href=/programming-guides/proto3#maps>Proto3 maps</a>の導入以前、サービスは時々、スカラーフィールドを持つアドホックなKVPairメッセージを使用してデータをペアとして公開していました。最終的にクライアントはより深い構造が必要となり、何らかの方法で解析する必要があるキーまたは値を考案することになります。<a href=#dont-encode-data-in-a-string>文字列にデータをエンコードしない</a>を参照してください。</p><p>したがって、値に(拡張可能な)メッセージ型を使用することは、単純な設計よりも即座に改善されます。</p><p>マップはすべての言語でproto2に後方互換性がありましたので、<code>map&lt;scalar, **message**></code>を使用することは、同じ目的のために独自のKVPairを発明するよりも良いです<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>。</p><p>もし、<em>事前にわからない</em> 構造の任意のデータを表現したい場合は、<a href=/reference/protobuf/textformat-spec#any><code>google.protobuf.Any</code></a> を使用してください。</p><h2 id=prefer-idempotency>冪等性を好む</h2><p>上位のスタックのどこかに、クライアントにリトライロジックがあるかもしれません。リトライがミューテーションである場合、ユーザーは驚くかもしれません。重複したコメント、ビルドリクエスト、編集などは誰にとっても良いものではありません。</p><p>重複した書き込みを避ける簡単な方法は、クライアントがクライアント作成のリクエスト ID を指定できるようにし、サーバーがそれを重複排除することです（たとえば、コンテンツのハッシュまたは UUID）。</p><h2 id=service-name-globally-unique>サービス名に注意し、グローバルに一意にする</h2><p>サービス名（つまり、<code>.proto</code> ファイル内の <code>service</code> キーワードの後にある部分）は、サービスクラス名を生成するだけでなく、驚くほど多くの場所で使用されます。これにより、この名前は思っているよりも重要になります。</p><p>トリッキーなのは、これらのツールが暗黙のうちに、サービス名がネットワーク全体で一意であるという前提を置いていることです。さらに悪いことに、彼らが使用するサービス名は <em>修飾されていない</em> サービス名です（たとえば、<code>MyService</code> のようなもの）、修飾されたサービス名ではありません（たとえば、<code>my_package.MyService</code> のようなもの）。</p><p>この理由から、特定のパッケージ内で定義されている場合でも、サービス名の名前の競合を防ぐための手順を踏むことが理にかなっています。例えば、<code>Watcher</code> という名前のサービスは問題を引き起こす可能性があります。<code>MyProjectWatcher</code> のようなものの方が良いでしょう。</p><h2 id=every-rpc-deadline>すべての RPC に（寛容な）締め切りを指定して強制する</h2><p>デフォルトでは、RPC にはタイムアウトがありません。リクエストがバックエンドリソースを縛り付ける可能性があるため、すべての適切なリクエストが完了することを許可するデフォルトの締め切りを設定することは、良い防御的な慣行です。これを強制しないことは、過去に主要なサービスに深刻な問題を引き起こしたことがあります。RPC クライアントは、標準フレームワークを使用する場合、通常、出力 RPC に締め切りを設定する必要があります。締め切りは、リクエストに添付されたより短い締め切りによって上書きされる場合があり、通常はされます。</p><p>設定<code>deadline</code>オプションは、RPCの締め切りをクライアントに明確に伝え、標準フレームワークによって尊重され、強制されます。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>rpc</span> <span style=color:#000>Foo</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>FooRequest</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>returns</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>FooResponse</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>option</span> <span style=color:#000>deadline</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>x</span><span style=color:#000;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// 一般的に適切なデフォルトはありません
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>締め切り値を選択することは、システムが負荷下でどのように動作するかに特に影響します。既存のサービスの場合、新しい締め切りを強制する前に既存のクライアントの動作を評価することが重要です（SREに相談してください）。場合によっては、後から短い締め切りを強制することができない場合もあります。</p><h2 id=bound-req-res-sizes>リクエストとレスポンスのサイズを制限する</h2><p>リクエストとレスポンスのサイズは制限されるべきです。
おおよその制限値として8 MiBを推奨し、2 GiBは多くのproto実装が壊れるハードリミットです。
多くのストレージシステムはメッセージサイズに制限を設けています。</p><p>また、無制限のメッセージは以下のような問題を引き起こします。</p><ul><li>クライアントとサーバの両方を膨らませます。</li><li>高く予測不能な遅延を引き起こします。</li><li>単一のクライアントと単一のサーバ間の長寿命接続に依存することで、回復力が低下します。</li></ul><p>API内のすべてのメッセージを制限するいくつかの方法は次のとおりです。</p><ul><li>各RPC呼び出しが論理的に他と独立しているバウンドされたメッセージを返すRPCを定義します。</li><li>無制限の、クライアントが指定したオブジェクトのリストではなく、単一のオブジェクトに対応するRPCを定義します。</li><li>無制限のデータを文字列、バイト、または繰り返しフィールドにエンコードしないようにします。</li><li>長時間実行される操作を定義します。結果をスケーラブルで同時読み取りが可能なストレージシステムに保存します。</li><li>ページネーションAPIを使用します（<a href=#define-pagination-api>継続トークンなしでページネーションAPIを定義しない</a>を参照）。</li><li>ストリーミングRPCを使用します。</li></ul><p>UIに取り組んでいる場合は、<a href=#create-methods-manipulate-small-bits>小さなデータを返すまたは操作するメソッドを作成する</a>も参照してください。</p><h2 id=propagate-status-codes>ステータスコードを慎重に伝播する</h2><p>RPCサービスは、RPCの境界でエラーを調査し、呼び出し元に意味のあるステータスエラーを返すために注意を払う必要があります。</p><p>ポイントを説明するために、おもちゃの例を見てみましょう。</p><p>クライアントが <code>ProductService.GetProducts</code> を呼び出すと考えてみましょう。このメソッドは引数を取りません。<code>GetProducts</code> の一部として、<code>ProductService</code> はすべての製品を取得し、各製品に対して <code>LocaleService.LocaliseNutritionFacts</code> を呼び出すかもしれません。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>digraph toy_example {
</span></span><span style=display:flex><span>  node [style=filled]
</span></span><span style=display:flex><span>  client [label=&#34;Client&#34;];
</span></span><span style=display:flex><span>  product [label=&#34;ProductService&#34;];
</span></span><span style=display:flex><span>  locale [label=&#34;LocaleService&#34;];
</span></span><span style=display:flex><span>  client -&gt; product [label=&#34;GetProducts&#34;]
</span></span><span style=display:flex><span>  product -&gt; locale [label=&#34;LocaliseNutritionFacts&#34;]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>ProductService</code> が誤って実装されている場合、<code>LocaleService</code> に誤った引数を送信する可能性があり、<code>INVALID_ARGUMENT</code> が発生します。</p><p><code>ProductService</code> が呼び出し元にエラーを適当に返すと、クライアントは <code>INVALID_ARGUMENT</code> を受け取ります。なぜなら、ステータスコードは RPC 境界を越えて伝播するからです。しかし、クライアントは <code>ProductService.GetProducts</code> に引数を渡していません。そのため、エラーは無意味以上のものになります。混乱を招くだけです！</p><p>代わりに、<code>ProductService</code> は RPC 境界で受け取ったエラーを調査すべきです。つまり、<code>ProductService</code> が実装する RPC ハンドラーです。ユーザーに意味のあるエラーを返すべきです。たとえば、呼び出し元から無効な引数を受け取った場合は <code>INVALID_ARGUMENT</code> を返すべきです。下流で何かが無効な引数を受け取った場合は、エラーを呼び出し元に返す前に <code>INVALID_ARGUMENT</code> を <code>INTERNAL</code> に変換すべきです。</p><p>適当にステータスエラーを伝播させると混乱を招き、デバッグに非常に高いコストがかかる可能性があります。さらに悪いことに、クライアントエラーをすべてのサービスが転送しても、アラートが発生しない不可視の障害が発生する可能性があります。</p><p>一般的なルールは次のとおりです。RPC 境界では、エラーを調査し、適切なステータスコードを持つ意味のあるステータスエラーを呼び出し元に返すように注意してください。意味を伝えるために、各 RPC メソッドはどの状況でどのエラーコードを返すかを文書化すべきです。各メソッドの実装は文書化された API 契約に準拠すべきです。</p><h2 id=unique-protos>各メソッドごとに固有のプロトを作成</h2><p>各 RPC メソッドに固有のリクエストおよびレスポンスプロトを作成してください。後でトップレベルのリクエストまたはレスポンスを分岐する必要があることがわかると、コストがかかります。これには「空」のレスポンスも含まれます。<a href=https://github.com/protocolbuffers/protobuf/blob/main/src/google/protobuf/empty.proto>well-known Empty message type</a> を再利用する代わりに、固有の空のレスポンスプロトを作成してください。</p><h3 id=reuse-messages>メッセージの再利用</h3><p>メッセージを再利用するには、複数のリクエストとレスポンスプロトに含めるための共有の &ldquo;ドメイン&rdquo; メッセージタイプを作成します。アプリケーションロジックをこれらのタイプに基づいて記述し、リクエストとレスポンスのタイプではなく、それらのタイプに基づいてください。</p><p>これにより、メソッドのリクエスト/レスポンスタイプを独立して進化させる柔軟性が得られますが、論理的なサブユニットのコードを共有できます。</p><h2 id=appendix>付録</h2><h3 id=returning-repeated-fields>繰り返しフィールドの返却</h3><p>繰り返しフィールドが空の場合、クライアントはそのフィールドがサーバーによって設定されていないのか、バッキングデータが実際に空なのかを区別できません。言い換えれば、繰り返しフィールドには <code>hasFoo</code> メソッドがありません。</p><p>繰り返しフィールドをメッセージでラップすると、hasFoo メソッドを簡単に取得できます。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>FooList</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#000>Foo</span> <span style=color:#000>foos</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>より包括的な解決方法は、フィールドの<a href=#include-field-read-mask>読み取りマスク</a>を使用することです。フィールドがリクエストされた場合、空のリストはデータがないことを意味します。フィールドがリクエストされていない場合、クライアントはレスポンスのフィールドを無視すべきです。</p><h3 id=updating-repeated-fields>繰り返しフィールドの更新</h3><p>繰り返しフィールドを更新する最悪の方法は、クライアントに置き換えリストを提供させることです。クライアントに対して配列全体を提供することで発生する危険は多岐にわたります。未知のフィールドを保持しないクライアントはデータ損失を引き起こします。同時書き込みはデータ損失を引き起こします。これらの問題が当てはまらなくても、クライアントはフィールドがサーバーサイドでどのように解釈されるかを知るために、注意深くドキュメントを読む必要があります。空のフィールドはサーバーが更新しないことを意味するのか、サーバーがクリアすることを意味するのか？</p><p><strong>修正 #1</strong>: クライアントが配列全体を提供せずに、配列に要素を置換、削除、挿入できる繰り返し更新マスクを使用します。</p><p><strong>修正 #2</strong>: リクエストプロトに別々の追加、置換、削除配列を作成します。</p><p><strong>修正 #3</strong>: 追加またはクリアのみを許可します。これは、繰り返しフィールドをメッセージでラップすることで行うことができます。存在するが空のメッセージはクリアを意味し、それ以外の繰り返し要素は追加を意味します。</p><h3 id=order-independence-repeated-fields>繰り返しフィールドにおける順序の独立性</h3><p>一般的に順序依存性を避けてください。これは余分な脆弱性の層です。特に悪いタイプの順序依存性は、平行配列です。平行配列はクライアントが結果を解釈するのをより難しくし、自分自身のサービス内で関連する2つのフィールドを渡すことを不自然にします。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>BatchEquationSolverResponse</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Bad: Solved values are returned in the order of the equations given in
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// the request.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#204a87;font-weight:700>double</span> <span style=color:#000>solved_values</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// (Usually) Bad: Parallel array for solved_values.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#204a87;font-weight:700>double</span> <span style=color:#000>solved_complex_values</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic>// Good: A separate message that can grow to include more fields and be
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// shared among other methods. No order dependence between request and
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// response, no order dependence between multiple repeated fields.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>BatchEquationSolverResponse</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Deprecated, this will continue to be populated in responses until Q2
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// 2014, after which clients must move to using the solutions field below.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#204a87;font-weight:700>double</span> <span style=color:#000>solved_values</span> <span style=color:#000;font-weight:700>[</span><span style=color:#000>deprecated</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>];</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Good: Each equation in the request has a unique identifier that&#39;s
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// included in the EquationSolution below so that the solutions can be
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// correlated with the equations themselves. Equations are solved in
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// parallel and as the solutions are made they are added to this array.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#000>EquationSolution</span> <span style=color:#000>solutions</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><h3 id=leaking-features>モバイルビルドでProtoが漏洩する機能</h3><p>AndroidとiOSのランタイムはどちらもリフレクションをサポートしています。そのため、フィールドやメッセージの未加工の名前がアプリケーションバイナリ（APK、IPA）に文字列として埋め込まれます。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Foo</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// This will leak existence of Google Teleport project on Android and iOS
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>FeatureStatus</span> <span style=color:#000>google_teleport_enabled</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>いくつかの緩和策:</p><ul><li>AndroidでのProGuardの難読化。2014年第3四半期現在。iOSには難読化オプションがありません: デスクトップ上でIPAを持っていると、<code>strings</code>を通してパイプ処理すると、含まれるProtoのフィールド名が明らかになります。
<a href=https://github.com/Bensge/Chrome-for-iOS-Headers>iOS Chrome tear-down</a></li><li>モバイルクライアントに送信されるフィールドを厳密に選定する。</li><li>漏洩を抑制することが受け入れ可能なスケジュールで実現不可能であれば、機能所有者からリスクを受け入れるための承認を取得します。</li></ul><p><em>決して</em>これをフィールドの意味を難読化するための言い訳として使用しないでください。漏洩を抑制するか、リスクを受け入れるための承認を取得してください。</p><h3 id=performance-optimizations>パフォーマンスの最適化</h3><p>一部のケースでは、パフォーマンスの向上のために型の安全性や明瞭さを犠牲にすることができます。例えば、数百のフィールドを持つProtoは、特にメッセージ型のフィールドが多い場合、少ないフィールドを持つProtoよりも解析が遅くなります。非常に深くネストされたメッセージは、メモリ管理からだけでも遅くなる可能性があります。デシリアライズを高速化するためにチームが使用してきたいくつかのテクニック:</p><ul><li>大きなProtoを反映するが、一部のタグのみが宣言された並行したトリムされたProtoを作成します。すべてのフィールドが必要ない場合に解析に使用します。トリムされたProtoが番号の「穴」を蓄積するにつれて、タグ番号が引き続き一致するように強制するテストを追加します。</li><li>フィールドを<a href=https://github.com/protocolbuffers/protobuf/blob/cacb096002994000f8ccc6d9b8e1b5b0783ee561/src/google/protobuf/descriptor.proto#L609>[lazy=true]</a>として「遅延解析」するように注釈を付けます。</li><li>フィールドをバイトとして宣言し、そのタイプを文書化します。フィールドを解析する必要があるクライアントは、手動で行うことができます。このアプローチの危険性は、誰かが誤ったタイプのメッセージをバイトフィールドに入れることを防ぐものがないことです。ログに書き込まれるProtoには決してこれを行わないでください。これにより、PIIの検証やポリシーまたはプライバシーの理由でProtoがスクラブされるのが妨げられます。</li></ul><p>I am ready to translate the Markdown content into Japanese. Please go ahead and paste the content you would like me to translate.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><code>map&lt;k,v></code> フィールドを含むプロトに関する落とし穴。MapReduce でリデュースキーとして使用しないでください。proto3 マップアイテムのワイヤーフォーマットと反復順序は <em>未指定</em> であり、これにより一貫性のないマップシャードが生じます。&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Stack Overflow" aria-label="Stack Overflow"><a class=text-white target=_blank rel=noopener href=https://stackoverflow.com/questions/tagged/protocol-buffers aria-label="Stack Overflow"><i class="fab fa-stack-overflow"></i></a></li></ul><script type=text/javascript id=cookiebanner src=https://cdn.jsdelivr.net/gh/dobarkod/cookie-banner@1.2.2/dist/cookiebanner.min.js data-height=50px data-message="Protobuf.dev uses cookies from Google to deliver and enhance the quality of its services and to analyze traffic." data-bg=#ffb data-fg=#000 data-position=bottom data-padding="10px 16px" data-close-text="OK, got it" data-font-size=18px data-moreinfo=https://policies.google.com/technologies/cookies></script></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel=noopener href=https://github.com/protocolbuffers/protobuf aria-label=GitHub><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Developer mailing list" aria-label="Developer mailing list"><a class=text-white target=_blank rel=noopener href=https://groups.google.com/g/protobuf aria-label="Developer mailing list"><i class="fa fa-envelope"></i></a></li></ul><script type=text/javascript id=cookiebanner src=https://cdn.jsdelivr.net/gh/dobarkod/cookie-banner@1.2.2/dist/cookiebanner.min.js data-height=50px data-message="Protobuf.dev uses cookies from Google to deliver and enhance the quality of its services and to analyze traffic." data-bg=#ffb data-fg=#000 data-position=bottom data-padding="10px 16px" data-close-text="OK, got it" data-font-size=18px data-moreinfo=https://policies.google.com/technologies/cookies></script></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2024 Google LLC All Rights Reserved</small>
<small class=ml-1><a href=https://policies.google.com/privacy target=_blank rel=noopener>プライバシーポリシー</a></small>
<span class=text-white>Hosted by GitHub Pages.</span> <a href=https://docs.github.com/en/site-policy/privacy-policies/github-privacy-statement target=_blank>GitHub Privacy Statement</a></div></div></div></footer></div><script src=/js/main.min.ba08a6b7f24e657f0a1b9b55be3a3162585168cd862ace0957f5b44e6cb6dc61.js integrity="sha256-ugimt/JOZX8KG5tVvjoxYlhRaM2GKs4JV/W0Tmy23GE=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script></body></html>